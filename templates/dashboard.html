<!-- RFBooking FastAPI OSS - Self-hosted Equipment Booking System -->
<!-- Copyright (C) 2025 Oleg Tokmakov -->
<!-- SPDX-License-Identifier: AGPL-3.0-or-later -->
{% extends "base.html" %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-gray-900 text-white">
        <div class="p-6">
            <h1 class="text-xl font-bold">{{ app_name }}</h1>
            <p class="text-gray-400 text-sm">{{ organization_name }}</p>
        </div>

        <nav class="mt-6">
            <a href="#bookings" onclick="showTab('bookings')"
                class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white" data-tab="bookings">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Bookings
            </a>
            <a href="#equipment" onclick="showTab('equipment')"
                class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white" data-tab="equipment">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                </svg>
                Equipment
            </a>
            {% if ai_enabled %}
            <a href="#ai-assistant" onclick="showTab('ai-assistant')"
                class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white" data-tab="ai-assistant">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                AI Assistant
            </a>
            {% endif %}
            <a href="#reports" onclick="showTab('reports')"
                class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white" data-tab="reports">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Reports
            </a>
            {% if user and user.role_id == 1 %}
            <a href="#admin" onclick="showTab('admin')"
                class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white" data-tab="admin">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Admin
            </a>
            {% endif %}
        </nav>

        <!-- User info -->
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-800">
            {% if user %}
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                    {{ user.name[0] | upper }}
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium">{{ user.name }}</p>
                    <p class="text-xs text-gray-400">{{ user.role_name | capitalize }}</p>
                </div>
            </div>
            <button onclick="logout()" class="mt-3 w-full text-left text-sm text-gray-400 hover:text-white">
                Sign out
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Bookings Tab -->
        <div id="tab-bookings" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">My Bookings</h2>
                <button onclick="showNewBookingModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    New Booking
                </button>
            </div>
            <div id="bookings-list" class="bg-white rounded-lg shadow">
                <div class="p-8 text-center text-gray-500">
                    Loading bookings...
                </div>
            </div>
        </div>

        <!-- Equipment Tab -->
        <div id="tab-equipment" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Equipment</h2>
                {% if user and user.role_id == 1 %}
                <button onclick="showNewEquipmentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Add Equipment
                </button>
                {% endif %}
            </div>
            <div id="equipment-list" class="grid gap-4">
                <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                    Loading equipment...
                </div>
            </div>
        </div>

        <!-- AI Assistant Tab -->
        <div id="tab-ai-assistant" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">AI Assistant</h2>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-gray-600 mb-4">Describe what equipment you need and the AI will recommend the best options.</p>
                <textarea id="ai-prompt" rows="4" class="w-full border rounded-lg p-3 mb-4" placeholder="e.g., I need a load-pull system for 800W at 2.4 GHz..."></textarea>
                <button onclick="askAI()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    Get Recommendations
                </button>
                <div id="ai-results" class="mt-6 hidden">
                    <h3 class="font-semibold mb-3">Recommendations</h3>
                    <div id="ai-recommendations"></div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="tab-reports" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Reports</h2>
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm uppercase">Total Bookings</h3>
                    <p id="stat-total-bookings" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm uppercase">Active Bookings</h3>
                    <p id="stat-active-bookings" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-gray-500 text-sm uppercase">Equipment Count</h3>
                    <p id="stat-equipment-count" class="text-3xl font-bold text-gray-800">-</p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold mb-4">Equipment Usage</h3>
                <div id="equipment-usage-list"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="tab-admin" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Admin Panel</h2>
            <div class="grid gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4">Users</h3>
                    <div id="users-list"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4">Cron Jobs</h3>
                    <div id="cron-jobs-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Booking Modal -->
<div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-xl font-bold mb-4">New Booking</h3>
        <form id="booking-form" onsubmit="createBooking(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Equipment</label>
                <select id="booking-equipment" required class="w-full border rounded-lg p-2">
                    <option value="">Select equipment...</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="booking-start-date" required class="w-full border rounded-lg p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" id="booking-end-date" required class="w-full border rounded-lg p-2">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                    <input type="time" id="booking-start-time" required class="w-full border rounded-lg p-2" value="08:00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                    <input type="time" id="booking-end-time" required class="w-full border rounded-lg p-2" value="18:00">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="booking-description" rows="3" class="w-full border rounded-lg p-2"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideBookingModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Create Booking
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize data from template
const userData = {{ user | tojson | safe if user else 'null' }};
const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrf_token='))?.split('=')[1] || '';

// Tab management
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-gray-800', 'text-white');
        link.classList.add('text-gray-300');
    });

    document.getElementById('tab-' + tabName).classList.remove('hidden');
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-gray-800', 'text-white');
    document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-300');

    // Load tab data
    if (tabName === 'bookings') loadBookings();
    if (tabName === 'equipment') loadEquipment();
    if (tabName === 'reports') loadReports();
    if (tabName === 'admin') loadAdminData();
}

// API helper
async function apiCall(url, method = 'GET', body = null) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken,
        },
    };
    if (body) options.body = JSON.stringify(body);
    const response = await fetch(url, options);
    return response.json();
}

// Load bookings
async function loadBookings() {
    const data = await apiCall('/api/bookings?user_id=' + (userData?.id || ''));
    const list = document.getElementById('bookings-list');

    if (!data.bookings?.length) {
        list.innerHTML = '<div class="p-8 text-center text-gray-500">No bookings found</div>';
        return;
    }

    list.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Equipment</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${data.bookings.map(b => `
                    <tr>
                        <td class="px-6 py-4">${escapeHtml(b.equipment_name || 'N/A')}</td>
                        <td class="px-6 py-4">${b.start_date} - ${b.end_date}</td>
                        <td class="px-6 py-4">${b.start_time?.slice(0,5)} - ${b.end_time?.slice(0,5)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded ${b.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${b.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${b.status === 'active' ? `<button onclick="cancelBooking(${b.id})" class="text-red-600 hover:underline">Cancel</button>` : ''}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Load equipment
async function loadEquipment() {
    const data = await apiCall('/api/equipment');
    const list = document.getElementById('equipment-list');

    if (!data.equipment?.length) {
        list.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">No equipment found</div>';
        return;
    }

    list.innerHTML = data.equipment.map(e => `
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between">
                <div>
                    <h3 class="font-semibold text-lg">${escapeHtml(e.name)}</h3>
                    <p class="text-gray-600 text-sm">${escapeHtml(e.type_name || 'No type')}</p>
                    <p class="text-gray-500 text-sm mt-1">${escapeHtml(e.location || 'No location')}</p>
                </div>
                <button onclick="showBookingModalForEquipment(${e.id}, '${escapeHtml(e.name)}')" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 h-fit">
                    Book
                </button>
            </div>
            ${e.description ? `<p class="text-gray-600 mt-3 text-sm">${escapeHtml(e.description.slice(0, 200))}${e.description.length > 200 ? '...' : ''}</p>` : ''}
        </div>
    `).join('');
}

// Load reports
async function loadReports() {
    const stats = await apiCall('/api/reports/booking-stats');
    if (stats.summary) {
        document.getElementById('stat-total-bookings').textContent = stats.summary.total || 0;
        document.getElementById('stat-active-bookings').textContent = stats.summary.active || 0;
    }

    const equipment = await apiCall('/api/equipment');
    document.getElementById('stat-equipment-count').textContent = equipment.equipment?.length || 0;

    const usage = await apiCall('/api/reports/equipment-usage');
    const usageList = document.getElementById('equipment-usage-list');

    if (usage.equipment?.length) {
        usageList.innerHTML = usage.equipment.map(e => `
            <div class="flex justify-between items-center py-2 border-b">
                <span>${escapeHtml(e.name)}</span>
                <span class="text-gray-500">${e.total_bookings} bookings</span>
            </div>
        `).join('');
    } else {
        usageList.innerHTML = '<p class="text-gray-500">No usage data</p>';
    }
}

// Load admin data
async function loadAdminData() {
    const users = await apiCall('/api/admin/users');
    const usersList = document.getElementById('users-list');

    if (users.users?.length) {
        usersList.innerHTML = `
            <table class="w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">Name</th>
                        <th class="text-left py-2">Email</th>
                        <th class="text-left py-2">Role</th>
                        <th class="text-left py-2">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.users.map(u => `
                        <tr class="border-b">
                            <td class="py-2">${escapeHtml(u.name)}</td>
                            <td class="py-2">${escapeHtml(u.email)}</td>
                            <td class="py-2">${u.role_name}</td>
                            <td class="py-2">
                                <span class="px-2 py-1 text-xs rounded ${u.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${u.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    const jobs = await apiCall('/api/admin/cron-jobs');
    const jobsList = document.getElementById('cron-jobs-list');

    if (jobs.jobs?.length) {
        jobsList.innerHTML = jobs.jobs.map(j => `
            <div class="flex justify-between items-center py-2 border-b">
                <div>
                    <span class="font-medium">${escapeHtml(j.job_name)}</span>
                    <span class="text-gray-500 text-sm ml-2">${j.cron_schedule}</span>
                </div>
                <span class="px-2 py-1 text-xs rounded ${j.is_enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                    ${j.is_enabled ? 'Enabled' : 'Disabled'}
                </span>
            </div>
        `).join('');
    }
}

// AI Assistant
async function askAI() {
    const prompt = document.getElementById('ai-prompt').value;
    if (!prompt) return;

    const results = document.getElementById('ai-results');
    const recommendations = document.getElementById('ai-recommendations');

    results.classList.remove('hidden');
    recommendations.innerHTML = '<div class="text-gray-500">Analyzing...</div>';

    const data = await apiCall('/api/ai/analyze', 'POST', { prompt });

    if (data.recommendations?.length) {
        recommendations.innerHTML = data.recommendations.map(r => `
            <div class="border rounded-lg p-4 mb-3">
                <h4 class="font-semibold">${escapeHtml(r.name)}</h4>
                <p class="text-gray-600 text-sm mt-1">${escapeHtml(r.reasoning || 'Recommended by AI')}</p>
                <button onclick="showBookingModalForEquipment(${r.equipment_id}, '${escapeHtml(r.name)}')" class="text-blue-600 hover:underline mt-2 text-sm">
                    Book this equipment
                </button>
            </div>
        `).join('');
    } else {
        recommendations.innerHTML = '<p class="text-gray-500">No recommendations found. Try describing your requirements differently.</p>';
    }
}

// Booking modal
let selectedEquipmentId = null;

function showNewBookingModal() {
    loadEquipmentOptions();
    document.getElementById('booking-modal').classList.remove('hidden');
    document.getElementById('booking-modal').classList.add('flex');
}

function showBookingModalForEquipment(equipmentId, name) {
    selectedEquipmentId = equipmentId;
    loadEquipmentOptions().then(() => {
        document.getElementById('booking-equipment').value = equipmentId;
    });
    document.getElementById('booking-modal').classList.remove('hidden');
    document.getElementById('booking-modal').classList.add('flex');
}

function hideBookingModal() {
    document.getElementById('booking-modal').classList.add('hidden');
    document.getElementById('booking-modal').classList.remove('flex');
    document.getElementById('booking-form').reset();
}

async function loadEquipmentOptions() {
    const data = await apiCall('/api/equipment');
    const select = document.getElementById('booking-equipment');
    select.innerHTML = '<option value="">Select equipment...</option>' +
        (data.equipment || []).map(e => `<option value="${e.id}">${escapeHtml(e.name)}</option>`).join('');
}

async function createBooking(event) {
    event.preventDefault();

    const body = {
        equipment_id: parseInt(document.getElementById('booking-equipment').value),
        start_date: document.getElementById('booking-start-date').value,
        end_date: document.getElementById('booking-end-date').value,
        start_time: document.getElementById('booking-start-time').value + ':00',
        end_time: document.getElementById('booking-end-time').value + ':00',
        description: document.getElementById('booking-description').value,
    };

    const data = await apiCall('/api/bookings', 'POST', body);

    if (data.success) {
        hideBookingModal();
        loadBookings();
        alert('Booking created successfully!');
    } else {
        alert(data.detail?.message || data.detail || 'Failed to create booking');
    }
}

async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) return;

    const data = await apiCall(`/api/bookings/${bookingId}`, 'DELETE');
    if (data.success) {
        loadBookings();
    } else {
        alert(data.detail || 'Failed to cancel booking');
    }
}

// Logout
async function logout() {
    await apiCall('/api/auth/logout', 'POST');
    window.location.href = '/login';
}

// Utility
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    showTab('bookings');
});
</script>
{% endblock %}
