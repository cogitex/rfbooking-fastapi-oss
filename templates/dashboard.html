<!-- RFBooking FastAPI OSS - Self-hosted Equipment Booking System -->
<!-- Copyright (C) 2025 Oleg Tokmakov -->
<!-- SPDX-License-Identifier: AGPL-3.0-or-later -->
{% extends "base.html" %}

{% block title %}Dashboard - {{ app_name }}{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">{{ app_name }}</div>
            <div class="sidebar-subtitle">{{ organization_name }}</div>
            <div id="sidebar-date" class="sidebar-date"></div>
        </div>

        <nav class="sidebar-nav">
            <!-- User Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Dashboard</div>
                <a onclick="showSection('information')" class="sidebar-link active" data-section="information">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Information
                </a>
                <a onclick="showSection('new-booking')" class="sidebar-link" data-section="new-booking">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    New Booking
                </a>
                {% if ai_enabled %}
                <a onclick="showSection('ai-assistant')" class="sidebar-link" data-section="ai-assistant">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    AI Assistant
                </a>
                {% endif %}
                <a onclick="showSection('reports')" class="sidebar-link" data-section="reports">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Reports & Analytics
                </a>
            </div>

            <!-- Manager Section -->
            {% if user and user.role_id <= 2 %}
            <div class="sidebar-section">
                <div class="sidebar-section-title">Manager</div>
                <a onclick="showSection('type-access')" class="sidebar-link" data-section="type-access">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    Type Access
                </a>
            </div>
            {% endif %}

            <!-- Admin Section -->
            {% if user and user.role_id == 1 %}
            <div class="sidebar-section">
                <div class="sidebar-section-title">Admin</div>
                <a onclick="showSection('user-management')" class="sidebar-link" data-section="user-management">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    Users
                </a>
                <a onclick="showSection('equipment-management')" class="sidebar-link" data-section="equipment-management">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    Equipment
                </a>
                <a onclick="showSection('cron-jobs')" class="sidebar-link" data-section="cron-jobs">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Cron Jobs
                </a>
                {% if ai_enabled %}
                <a onclick="showSection('ai-rules')" class="sidebar-link" data-section="ai-rules">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    AI Rules
                </a>
                <a onclick="showSection('ai-chat')" class="sidebar-link" data-section="ai-chat">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    AI Chat
                </a>
                {% endif %}
            </div>
            {% endif %}
        </nav>

        <!-- User widget -->
        <div class="sidebar-user">
            {% if user %}
            <div class="sidebar-user-info">
                <div class="sidebar-user-avatar">{{ user.name[0] | upper }}</div>
                <div>
                    <div class="sidebar-user-name">{{ user.name }}</div>
                    <span class="role-badge role-badge-{{ user.role_name | lower }}">{{ user.role_name }}</span>
                </div>
            </div>
            <button onclick="logout()" class="mt-3 w-full text-left text-sm text-gray-400 hover:text-white transition-colors">
                Sign out
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- ===================================================================
             SECTION: Information
             =================================================================== -->
        <div id="section-information" class="section-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>

            <!-- User Info Card -->
            <div class="card card-info mb-6">
                <div class="card-header cursor-pointer" onclick="toggleCard('userInfo')">
                    <div class="flex items-center justify-between w-full">
                        <h2 class="text-lg font-bold">Your Information</h2>
                        <span id="userInfoToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="userInfoContent" class="card-body py-3 px-4">
                    <!-- First Row: Name, Role, Organization -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Name</label>
                            <p id="userName" class="text-sm text-gray-900 font-medium">{{ user.name if user else 'Loading...' }}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Role</label>
                            <p id="userRoleInfo" class="inline-block">
                                <span class="badge badge-{{ user.role_name | lower if user else 'user' }}">{{ user.role_name if user else 'User' }}</span>
                            </p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Org</label>
                            <p id="userOrg" class="text-sm text-gray-900 font-medium">{{ organization_name }}</p>
                        </div>
                    </div>

                    <!-- Second Row: Email, Last Login, Session Expiry -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Email</label>
                            <p id="userEmailInfo" class="text-sm text-gray-900 font-medium truncate">{{ user.email if user else 'Loading...' }}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Last Login</label>
                            <p id="userLastLogin" class="text-sm text-gray-700">{% if user and user.last_login_at %}{{ user.last_login_at }}{% else %}Never{% endif %}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 uppercase">Session</label>
                            <p id="cookieLifetime" class="text-xs text-gray-700">Calculating...</p>
                        </div>
                    </div>

                    <!-- Email Notifications Toggle -->
                    <div class="mt-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-semibold text-gray-700">Email Notifications</label>
                                <p class="text-xs text-gray-600 mt-1">Receive booking reminders and updates via email</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="emailNotificationsToggle" class="sr-only peer"
                                       {{ 'checked' if user and user.email_notifications_enabled else '' }}
                                       onchange="updateEmailNotificationPreference(this.checked)">
                                <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4
                                            peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full
                                            peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px]
                                            after:left-[2px] after:bg-white after:border-gray-300 after:border
                                            after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500">
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Logout Link -->
                    <div class="flex items-center gap-2 mt-4">
                        <a href="#" onclick="logoutUser(); return false;" class="text-xs text-red-600 hover:text-red-700 font-medium transition-colors">Logout</a>
                        <span class="text-xs text-gray-500">â€” You'll need to request a new registration link to log in again.</span>
                    </div>
                </div>
            </div>

            <!-- My Bookings Card -->
            <div class="card card-booking mb-6">
                <div class="card-header cursor-pointer" onclick="toggleCard('myBookings')">
                    <div class="flex items-center justify-between w-full">
                        <h2 class="text-lg font-bold">My Bookings</h2>
                        <span id="myBookingsToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="myBookingsContent" class="card-body">
                    <div id="my-bookings-summary" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[550px] overflow-y-auto">
                        <p class="text-gray-500 text-center py-8 col-span-full">Loading bookings...</p>
                    </div>
                </div>
            </div>

            <!-- System-wide User Policies -->
            <div class="card">
                <div class="card-header cursor-pointer" onclick="toggleCard('userPolicies')">
                    <div class="flex items-center justify-between w-full">
                        <div>
                            <h2 class="text-lg font-bold text-brand-700">
                                <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                                System-wide User Policies
                            </h2>
                            <p class="text-sm text-gray-600">Security and usage limits applied to all users</p>
                        </div>
                        <span id="userPoliciesToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="userPoliciesContent" class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <!-- Token Limit Policy -->
                        <div class="flex items-start p-3 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-semibold text-blue-900">Active Sessions Limit</h3>
                                <p class="text-sm text-blue-800 mt-1">
                                    <span class="font-bold text-lg">10</span> maximum active tokens per user
                                </p>
                                <p class="text-xs text-blue-700 mt-2">
                                    Users can be logged in on up to 10 devices simultaneously. Oldest sessions are automatically logged out when this limit is exceeded.
                                </p>
                            </div>
                        </div>

                        <!-- Booking Limit Policy -->
                        <div class="flex items-start p-3 bg-green-50 border-l-4 border-green-500 rounded-lg">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-semibold text-green-900">Daily Booking Limit</h3>
                                <p class="text-sm text-green-800 mt-1">
                                    <span class="font-bold text-lg">20</span> maximum bookings per day
                                </p>
                                <p class="text-xs text-green-700 mt-2">
                                    Each user can create up to 20 new bookings per day. This prevents system abuse and ensures fair resource allocation.
                                </p>
                                <p class="text-xs text-green-700 mt-2 pt-2 border-t border-green-200">
                                    <strong>Note:</strong> Regular users are limited to 5 notification emails per day (booking and cancellation confirmations, reminders) to prevent inbox overload.
                                </p>
                            </div>
                        </div>

                        <!-- Booking Duration Limit Policy -->
                        <div class="flex items-start p-3 bg-purple-50 border-l-4 border-purple-500 rounded-lg">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-semibold text-purple-900">Maximum Booking Duration</h3>
                                <p class="text-sm text-purple-800 mt-1">
                                    <span class="font-bold text-lg">30 days</span> maximum per single booking
                                </p>
                                <p class="text-xs text-purple-700 mt-2">
                                    Each individual booking can span up to 30 days (1 month). This ensures fair equipment sharing and prevents long-term monopolization.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-gray-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="text-xs text-gray-600">
                                <p class="font-medium text-gray-800 mb-1">Policy Notes:</p>
                                <ul class="list-disc list-inside space-y-1 ml-2">
                                    <li>These limits apply to all user roles (user, manager, admin)</li>
                                    <li>Daily limits reset at midnight UTC</li>
                                    <li>Token limit ensures security and session hygiene</li>
                                    <li>Daily booking limit prevents accidental or malicious system overload</li>
                                    <li>Booking duration limit promotes fair equipment sharing across users</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: New Booking
             =================================================================== -->
        <div id="section-new-booking" class="section-content hidden">
            <!-- Equipment Selection Card -->
            <div class="card mb-6">
                <div class="card-header cursor-pointer" onclick="toggleCard('equipmentSelection')">
                    <div class="flex items-center justify-between w-full">
                        <h2 class="text-lg font-bold">Equipment Selection</h2>
                        <span id="equipmentSelectionToggle" class="text-xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="equipmentSelectionContent" class="card-body">
                    <!-- Equipment Type Filter -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Equipment Type</label>
                        <select id="equipment-type-filter" onchange="filterEquipment()" class="w-full border border-gray-800 rounded-lg p-2 bg-blue-50">
                            <option value="all">All Types</option>
                        </select>
                    </div>

                    <!-- Equipment Grid -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Available Equipment</label>
                        <div id="equipment-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="text-gray-500 text-center py-8 col-span-full">Loading equipment...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Details Card -->
            <div class="card mb-6">
                <div class="card-header">
                    <h2 id="bookingDetailsHeading" class="text-lg font-bold">Booking Details</h2>
                </div>
                <div class="card-body">
                    <!-- Selected Equipment Display -->
                    <div id="selected-equipment-display" class="equipment-details mb-6 hidden">
                        <div id="selected-equipment-name" class="equipment-details-name"></div>
                        <div id="selected-equipment-info" class="equipment-details-info"></div>
                    </div>

                    <!-- Calendar for Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Dates</label>
                        <div id="booking-calendar-container">
                            <p class="text-gray-500 text-center py-8">Select equipment to view calendar</p>
                        </div>
                    </div>

                    <!-- Time Range -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                            <input type="time" id="inline-start-time" class="w-full border rounded-lg p-2" value="08:00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                            <input type="time" id="inline-end-time" class="w-full border rounded-lg p-2" value="18:00">
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description (Project name, frequencies, etc.)</label>
                        <textarea id="inline-description" class="w-full border rounded-lg p-2" placeholder="Add booking notes..." rows="3" maxlength="10240" oninput="updateDescCharCount()"></textarea>
                        <div class="flex justify-between mt-1">
                            <span class="text-xs text-gray-500">Auto-expands as you type</span>
                            <span id="desc-char-count" class="text-xs text-gray-500">0 / 10,240</span>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex gap-3">
                        <button type="button" onclick="submitBooking()" id="inline-book-btn" class="btn-primary" disabled>Book Equipment</button>
                        <button type="button" onclick="resetBookingForm()" class="btn-secondary">Clear Form</button>
                    </div>

                    <!-- Message Display -->
                    <div id="booking-message" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: AI Assistant
             =================================================================== -->
        <div id="section-ai-assistant" class="section-content hidden">
            <div class="card mb-6">
                <div class="card-header">
                    <div>
                        <h2 class="text-lg font-bold">AI Booking Assistant</h2>
                        <p class="text-sm text-gray-600 mt-1">Describe your measurement needs in natural language and get equipment suggestions</p>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Search Settings -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-3">Search Settings</h3>
                        <div class="flex items-center gap-3">
                            <label for="ai-search-days" class="text-sm text-gray-700 whitespace-nowrap">
                                Search availability for next
                            </label>
                            <input type="number" id="ai-search-days" min="3" max="60" value="30"
                                class="w-20 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none text-center font-semibold">
                            <span class="text-sm text-gray-700">days</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Adjust how far ahead to search for available booking slots (3-60 days).
                        </p>
                    </div>

                    <!-- How it works -->
                    <div class="mb-6 p-4 bg-orange-50 border-l-4 border-orange-500 rounded">
                        <h3 class="font-semibold text-orange-900 mb-2">How it works</h3>
                        <ul class="text-sm text-orange-800 space-y-1 list-disc list-inside">
                            <li>Describe your measurement needs in plain English</li>
                            <li>For specific equipment types, use format: "[Type Name] type equipment" (e.g., "Load-Pull type equipment")</li>
                            <li>AI will suggest matching equipment and available dates. Note: AI can make mistakes in interpretation.</li>
                            <li>Click on suggested options to create bookings instantly</li>
                        </ul>
                    </div>

                    <!-- Quick Templates -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Quick Templates</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button type="button" onclick="setAIPrompt('I need to book Load-Pull type equipment for measurements at 1.3 GHz - 1.5 GHz at CW power 800W and second harmonic tuning for 5 days')"
                                class="template-card text-left p-3 border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all">
                                <div class="font-semibold text-gray-800 mb-1">Load-Pull Measurements</div>
                                <div class="text-xs text-gray-600">I need to book Load-Pull type equipment for measurements at 1.3 GHz - 1.5 GHz at CW power 800W...</div>
                            </button>

                            <button type="button" onclick="setAIPrompt('I need a thermal chamber for the measurements at 250degC for two days in the last week of January')"
                                class="template-card text-left p-3 border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all">
                                <div class="font-semibold text-gray-800 mb-1">Thermal Measurements</div>
                                <div class="text-xs text-gray-600">I need a thermal chamber for the measurements at 250degC for two days...</div>
                            </button>

                            <button type="button" onclick="setAIPrompt('I need Ansys license for two days starting next Tuesday')"
                                class="template-card text-left p-3 border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all">
                                <div class="font-semibold text-gray-800 mb-1">Ansys License</div>
                                <div class="text-xs text-gray-600">I need Ansys license for two days starting next Tuesday</div>
                            </button>

                            <button type="button" onclick="setAIPrompt('Can I book the wafer prober for the measurements at high temperature for 5 days in the first week of February next year?')"
                                class="template-card text-left p-3 border-2 border-gray-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all">
                                <div class="font-semibold text-gray-800 mb-1">On-wafer Measurements</div>
                                <div class="text-xs text-gray-600">Can I book the wafer prober for the measurements at high temperature for 5 days...</div>
                            </button>
                        </div>
                    </div>

                    <!-- Prompt Input -->
                    <div class="mb-6">
                        <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">Your Request</label>
                        <textarea id="ai-prompt" rows="4" maxlength="500"
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none resize-none"
                            placeholder="Example: Which load-pull systems available for tomorrow?"
                            oninput="updateAICharCount()"
                            onkeydown="handleAIKeydown(event)"></textarea>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-xs text-gray-500">Press Enter to send, Shift+Enter for new line</p>
                            <div class="flex items-center gap-3">
                                <span id="ai-char-count" class="text-xs text-gray-500">0 / 500</span>
                                <button type="button" onclick="clearAIPrompt()" class="text-xs text-gray-500 hover:text-gray-700 underline">Clear</button>
                            </div>
                        </div>

                        <!-- Send Button -->
                        <div class="mt-4">
                            <button id="ai-send-btn" type="button" onclick="askAI()"
                                class="w-full btn-primary py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2">
                                Get AI Suggestions
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="ai-loading" class="hidden mb-6 text-center py-8">
                        <div class="loading mx-auto" style="width: 48px; height: 48px; border-width: 4px;"></div>
                        <p class="mt-4 text-gray-600">AI is analyzing your request...</p>
                    </div>

                    <!-- Error Message -->
                    <div id="ai-error" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded">
                        <h4 class="font-semibold text-red-900 mb-1">Error</h4>
                        <p id="ai-error-message" class="text-sm text-red-800"></p>
                    </div>

                    <!-- AI Suggestions -->
                    <div id="ai-results" class="hidden mb-6">
                        <h3 class="font-semibold text-gray-800 mb-2">AI Suggestions</h3>
                        <p id="ai-explanation" class="text-base text-gray-900 font-medium mb-4"></p>
                        <div id="ai-recommendations" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        <div class="mt-4 text-center">
                            <button type="button" onclick="newAISearch()" class="text-sm text-orange-600 hover:text-orange-800 underline">New Search</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: Reports
             =================================================================== -->
        <div id="section-reports" class="section-content hidden">
            <!-- Booking History -->
            <div class="card card-reports mb-6">
                <div class="card-header cursor-pointer" onclick="toggleSection('bookingHistory')">
                    <div class="flex items-center justify-between w-full">
                        <div>
                            <h2 class="text-lg font-bold">Booking History</h2>
                        </div>
                        <span id="bookingHistoryToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="bookingHistoryContent" class="card-body">
                    <!-- Date Range Controls -->
                    <div class="mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="date" id="report-start-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="date" id="report-end-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="applyBookingFilter()" class="btn-primary">Apply</button>
                            <button onclick="loadReports()" class="btn-secondary">Load Reports</button>
                            <button onclick="exportReportsCSV()" class="btn-secondary">ðŸ“¥ Export CSV</button>
                        </div>
                    </div>

                    <!-- Booking History List -->
                    <div>
                        <h3 class="block text-sm font-medium text-gray-700 mb-2">My Past Bookings</h3>
                        <div id="bookingHistoryContainer" class="border border-gray-200 rounded-lg bg-white max-h-[600px] overflow-y-auto">
                            <div id="bookingHistoryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                                <div class="text-center py-8 text-gray-500 text-sm col-span-full">Loading bookings...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="statsCardsContainer">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Equipment Utilization Table -->
            <div class="card card-reports mb-6">
                <div class="card-header cursor-pointer" onclick="toggleSection('equipmentUtilization')">
                    <div class="flex items-center justify-between w-full">
                        <div>
                            <h2 class="text-lg font-bold">Equipment Utilization</h2>
                            <p class="text-sm text-gray-600">Utilization based on number of bookings / total days in range</p>
                        </div>
                        <span id="equipmentUtilizationToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="equipmentUtilizationContent" class="card-body overflow-x-auto">
                    <table id="equipmentUtilizationTable" class="w-full text-sm">
                        <thead class="border-b-2" style="border-color: var(--brand-200);">
                            <tr class="text-left">
                                <th class="pb-3 font-semibold text-gray-700">Equipment Name</th>
                                <th class="pb-3 font-semibold text-gray-700">Location</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Bookings</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Hours</th>
                                <th class="pb-3 font-semibold text-gray-700">Utilization</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentUtilizationBody" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8 text-gray-500">No data loaded</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Activity Table -->
            <div class="card card-reports mb-6">
                <div class="card-header cursor-pointer" onclick="toggleSection('userActivity')">
                    <div class="flex items-center justify-between w-full">
                        <div>
                            <h2 class="text-lg font-bold">User Activity</h2>
                        </div>
                        <span id="userActivityToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="userActivityContent" class="card-body overflow-x-auto">
                    <table id="userActivityTable" class="w-full text-sm">
                        <thead class="border-b-2" style="border-color: var(--brand-200);">
                            <tr class="text-left">
                                <th class="pb-3 font-semibold text-gray-700">User</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Active</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Cancelled</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Completed</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Avg Hrs/Booking</th>
                                <th class="pb-3 font-semibold text-gray-700 text-right">Total Hours</th>
                            </tr>
                        </thead>
                        <tbody id="userActivityBody" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500">No data loaded</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Equipment Section -->
            <div class="card card-reports mb-6">
                <div class="card-header cursor-pointer" onclick="toggleSection('topEquipment')">
                    <div class="flex items-center justify-between w-full">
                        <div>
                            <h2 class="text-lg font-bold">Top 10 Most Booked Equipment</h2>
                        </div>
                        <span id="topEquipmentToggle" class="text-2xl text-gray-500 transition-transform">â–¼</span>
                    </div>
                </div>
                <div id="topEquipmentContent" class="card-body">
                    <div id="topEquipmentContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Populated by JavaScript -->
                        <div class="text-center py-8 text-gray-500 text-sm col-span-full">No data loaded</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: Equipment Type Access (Manager)
             =================================================================== -->
        <div id="section-type-access" class="section-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Equipment Type Access Control</h2>

            <div class="card">
                <div class="card-header">
                    <span>Manage User Access</span>
                    <select id="type-access-filter" onchange="loadTypeAccess()" class="border rounded px-3 py-1">
                        <option value="">Select Equipment Type...</option>
                    </select>
                </div>
                <div class="card-body">
                    <div id="type-access-table">
                        <div class="text-gray-500 text-center py-4">Select an equipment type to manage access</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: User Management (Admin)
             =================================================================== -->
        <div id="section-user-management" class="section-content hidden">
            <!-- Registration Access Control Card -->
            <div class="card card-users mb-6">
                <div class="card-header">
                    <div>
                        <h2 class="text-lg font-bold">Registration Access Control</h2>
                        <p class="text-sm text-gray-600">Configure how users can register for your organization</p>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Domain-Based Registration -->
                    <div class="mb-4 pb-4 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">Domain-Based Registration</h3>
                                <p class="text-sm text-gray-600 mt-1">Allow ALL users with email addresses from specified domains</p>
                            </div>
                            <label class="toggle-switch-container">
                                <input type="checkbox" id="domainRegistrationToggle" onchange="updateRegistrationSettings()">
                                <div class="toggle-switch-slider"></div>
                            </label>
                        </div>
                        <!-- Domain Input -->
                        <div id="domainInputSection" class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Allowed Domain(s)</label>
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    id="allowedDomainsInput"
                                    placeholder="example.com"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent font-mono text-sm"
                                >
                                <button onclick="saveDomainSettings()" class="btn-primary text-sm">Save</button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Enter domain without @ (e.g., company.com). For multiple domains, separate with commas.</p>
                        </div>
                    </div>

                    <!-- Email-Based Registration -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">Email-Based Registration</h3>
                            <p class="text-sm text-gray-600 mt-1">Only allow specific pre-approved email addresses to register</p>
                        </div>
                        <label class="toggle-switch-container">
                            <input type="checkbox" id="emailRegistrationToggle" onchange="updateRegistrationSettings()">
                            <div class="toggle-switch-slider"></div>
                        </label>
                    </div>

                    <!-- Email Import Section (shown when email-based is enabled) -->
                    <div id="emailImportSection" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-900">Allowed Emails (<span id="allowedEmailsCount">0</span>)</h3>
                            <button class="btn-primary text-sm" onclick="openImportEmailsModal()">
                                ðŸ“¥ Import Emails
                            </button>
                        </div>
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table id="allowedEmailsTable" class="w-full text-sm">
                                <thead class="bg-gray-50 border-b-2" style="border-color: var(--brand-200);">
                                    <tr class="text-left">
                                        <th class="py-3 px-4 font-semibold text-gray-700">Email</th>
                                        <th class="py-3 px-4 font-semibold text-gray-700">Name</th>
                                        <th class="py-3 px-4 font-semibold text-gray-700">Status</th>
                                        <th class="py-3 px-4 font-semibold text-gray-700">Invited</th>
                                        <th class="py-3 px-4 font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allowedEmailsTableBody" class="divide-y divide-gray-100 bg-white">
                                    <tr><td colspan="5" class="text-center py-8 text-gray-500">Loading emails...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authentication Token Management Card -->
            <div class="card card-users mb-6">
                <div class="card-header">
                    <div>
                        <h2 class="text-lg font-bold">Authentication Token Management</h2>
                        <p class="text-sm text-gray-600">Manage user authentication tokens and force re-registration</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div class="flex-1">
                                <h3 class="text-sm font-semibold text-orange-900 mb-1">Delete Old Authentication Tokens</h3>
                                <p class="text-sm text-orange-800 mb-3">
                                    This action will delete all authentication tokens older than the specified number of days.
                                    Users who registered before this period will be forced to register again.
                                </p>
                                <div class="flex items-center gap-4">
                                    <div class="flex items-center gap-2">
                                        <label for="tokenAgeDays" class="text-sm font-medium text-orange-900">Delete tokens older than:</label>
                                        <input
                                            type="number"
                                            id="tokenAgeDays"
                                            min="0"
                                            max="180"
                                            value="5"
                                            class="w-20 px-3 py-2 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-center font-semibold"
                                        >
                                        <span class="text-sm text-orange-900 font-medium">days</span>
                                    </div>
                                    <button
                                        onclick="deleteOldTokens()"
                                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg transition-colors"
                                    >
                                        ðŸ—‘ï¸ Delete Old Tokens
                                    </button>
                                </div>
                                <p class="text-xs text-orange-700 mt-3 italic">
                                    âš ï¸ Warning: Affected users will need to request a new registration link to access the system again.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Mode Card -->
            <div class="card card-users mb-6">
                <div class="card-header">
                    <div>
                        <h2 class="text-lg font-bold">Service Mode</h2>
                        <p class="text-sm text-gray-600">Restrict login to admins only for maintenance or emergency situations</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">Service Mode</h3>
                            <p class="text-sm text-gray-600 mt-1">
                                When enabled, only administrators can log in. All other users will be prevented from accessing the system.
                            </p>
                            <p class="text-xs text-orange-600 mt-2">
                                âš ï¸ Use this mode for maintenance, emergency situations, or when you need to restrict system access temporarily.
                            </p>
                        </div>
                        <label class="toggle-switch-container ml-4">
                            <input type="checkbox" id="serviceModeToggle" onchange="toggleServiceMode()">
                            <div class="toggle-switch-slider inverted"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- User Management Table -->
            <div class="card card-users">
                <div class="card-header">
                    <div>
                        <h2 class="text-lg font-bold">User Management</h2>
                        <p class="text-sm text-gray-600">Manage user roles and access for your organization</p>
                    </div>
                </div>
                <div class="card-body overflow-x-auto p-0">
                    <table id="usersTable" class="w-full text-sm">
                        <thead class="border-b-2" style="border-color: var(--brand-200);">
                            <tr class="text-left">
                                <th class="py-3 px-4 font-semibold text-gray-700">Email</th>
                                <th class="py-3 px-4 font-semibold text-gray-700">Name</th>
                                <th class="py-3 px-4 font-semibold text-gray-700">Role</th>
                                <th class="py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="py-3 px-4 font-semibold text-gray-700">Last Login</th>
                                <th class="py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-100">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: Equipment Management (Admin)
             =================================================================== -->
        <div id="section-equipment-management" class="section-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Equipment Management</h2>

            <!-- AI-Friendly Description Guidelines -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-semibold text-blue-800 mb-2">Writing AI-Friendly Descriptions</h3>
                        <div class="text-sm text-blue-700 space-y-2">
                            <p class="font-medium">Equipment descriptions help the AI Assistant understand your equipment and make accurate recommendations. Follow these guidelines:</p>

                            <p class="font-bold text-red-600 mt-2">Keep descriptions concise but informative</p>

                            <div class="mt-3">
                                <p class="font-semibold">For Equipment Types:</p>
                                <ul class="list-disc ml-5 mt-1 space-y-1">
                                    <li>Describe what the equipment type is used for (purpose and applications)</li>
                                    <li>Example: "Systems for measuring RF device characteristics under various load conditions"</li>
                                </ul>
                            </div>

                            <div class="mt-3">
                                <p class="font-semibold">For Equipment Items:</p>
                                <ul class="list-disc ml-5 mt-1 space-y-1">
                                    <li>Include key specifications with units and ranges (e.g., "System RF Bandwidth (f0, GHz): 0.6 â€“ 4.0")</li>
                                    <li>Use consistent format: "Parameter Name (unit): min â€“ max" or "Parameter: value"</li>
                                    <li>Include capabilities and features (e.g., "2nd harmonic tuning capability")</li>
                                    <li>Mention power handling, frequency ranges, or other technical constraints</li>
                                </ul>
                            </div>

                            <div class="mt-3 p-2 bg-white rounded border border-blue-200">
                                <p class="font-semibold text-blue-900">Good Example:</p>
                                <p class="text-xs mt-1">"Load-Pull 3 Hybrid System with Load 2nd harmonic tuning capability<br>Power Handling CW/Pulsed (W): 100/1000<br>System RF Bandwidth (f0, GHz): 0.84 â€“ 4.0"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Inventory -->
            <div class="card card-equipment mb-6">
                <div class="card-header">
                    <div>
                        <h3 class="text-lg font-bold">Equipment Inventory</h3>
                        <p class="text-sm text-gray-600">Manage all equipment in your organization</p>
                    </div>
                    <button onclick="showEquipmentModal()" class="btn-primary text-sm">Add Equipment</button>
                </div>
                <div class="card-body p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b-2 border-brand-200">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-700">Name</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-700">Location</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-700">Type</th>
                                    <th class="py-3 px-4 text-center font-semibold text-gray-700">Managers</th>
                                    <th class="py-3 px-4 text-center font-semibold text-gray-700">Status</th>
                                    <th class="py-3 px-4 text-right font-semibold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="equipment-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="6" class="text-center text-gray-500 py-8">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Equipment Types -->
            <div class="card card-equipment">
                <div class="card-header">
                    <div>
                        <h3 class="text-lg font-bold">Equipment Types</h3>
                        <p class="text-sm text-gray-600">Categorize your equipment for better organization</p>
                    </div>
                    <button onclick="showTypeModal()" class="btn-secondary text-sm">Add Type</button>
                </div>
                <div class="card-body">
                    <div id="types-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: Cron Jobs (Admin)
             =================================================================== -->
        <div id="section-cron-jobs" class="section-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Cron Jobs</h2>
                <button onclick="loadCronJobs()" class="btn-secondary">ðŸ”„ Refresh</button>
            </div>

            <div id="cron-jobs-list" class="grid gap-4">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: AI Rules (Admin)
             =================================================================== -->
        <div id="section-ai-rules" class="section-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">AI Specification Rules</h2>
                <button onclick="showAIRuleModal()" class="btn-primary">Add Rule</button>
            </div>

            <div id="ai-rules-list" class="space-y-4">
                <div class="text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- ===================================================================
             SECTION: AI Chat (Admin)
             =================================================================== -->
        <div id="section-ai-chat" class="section-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">AI Chat</h2>

            <div class="card">
                <div class="card-header">
                    <span>Chat with AI</span>
                    <button onclick="clearChat()" class="btn-secondary text-sm">Clear Chat</button>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <div class="chat-message assistant">
                                Hello! I'm your AI assistant. I can help you with equipment recommendations, answer questions about specifications, or assist with booking decisions. How can I help you today?
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <textarea id="chat-input" class="chat-input" rows="2" placeholder="Type your message..." onkeydown="handleChatKeydown(event)"></textarea>
                            <button onclick="sendChatMessage()" class="chat-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===================================================================
     MODALS
     =================================================================== -->

<!-- Role Edit Modal -->
<div id="role-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit User Role</h3>
            <button onclick="hideRoleModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="role-modal-user-id">
            <div class="space-y-3">
                <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="new-role" value="1" class="mr-3">
                    <div>
                        <div class="font-medium">Admin</div>
                        <div class="text-sm text-gray-500">Full access to all features</div>
                    </div>
                </label>
                <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="new-role" value="2" class="mr-3">
                    <div>
                        <div class="font-medium">Manager</div>
                        <div class="text-sm text-gray-500">Manage equipment and view all bookings</div>
                    </div>
                </label>
                <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="new-role" value="3" class="mr-3">
                    <div>
                        <div class="font-medium">User</div>
                        <div class="text-sm text-gray-500">Create and manage own bookings</div>
                    </div>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="hideRoleModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveUserRole()" class="btn-primary">Save</button>
        </div>
    </div>
</div>

<!-- Import Emails Modal -->
<div id="importEmailsModalOverlay" class="modal-backdrop hidden">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Import Allowed Emails</h3>
            <button onclick="closeImportEmailsModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                Enter email addresses and optional names, one per line. Format: <code class="bg-gray-100 px-1 rounded">email@example.com, Name</code>
            </p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email List</label>
                <textarea
                    id="importEmailsTextarea"
                    rows="10"
                    class="w-full border border-gray-300 rounded-lg p-3 font-mono text-sm"
                    placeholder="john@example.com, John Doe
jane@example.com, Jane Smith
bob@example.com"
                ></textarea>
            </div>
            <div id="importPreviewSection" class="hidden mb-4">
                <h4 class="font-medium text-gray-700 mb-2">Preview (<span id="importPreviewCount">0</span> emails)</h4>
                <div class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="py-2 px-3 text-left font-medium text-gray-600">Email</th>
                                <th class="py-2 px-3 text-left font-medium text-gray-600">Name</th>
                                <th class="py-2 px-3 text-left font-medium text-gray-600">Status</th>
                            </tr>
                        </thead>
                        <tbody id="importPreviewTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="importErrorSection" class="hidden mb-4">
                <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                    <h4 class="font-medium text-red-800 mb-1">Validation Errors</h4>
                    <ul id="importErrorList" class="text-sm text-red-700 list-disc list-inside"></ul>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeImportEmailsModal()" class="btn-secondary">Cancel</button>
            <button onclick="previewImportEmails()" class="btn-secondary">Preview</button>
            <button onclick="confirmImportEmails()" class="btn-primary" id="confirmImportBtn">Import</button>
        </div>
    </div>
</div>

<!-- Equipment Modal -->
<div id="equipment-modal" class="modal-backdrop hidden">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="equipment-modal-title">Add Equipment</h3>
            <button onclick="hideEquipmentModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="equipment-form">
                <input type="hidden" id="equipment-modal-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input type="text" id="equipment-name" required class="w-full border rounded-lg p-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="equipment-description" rows="3" class="w-full border rounded-lg p-2" placeholder="Include technical specs for AI recommendations"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" id="equipment-location" class="w-full border rounded-lg p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="equipment-type" class="w-full border rounded-lg p-2">
                            <option value="">No type</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Calibration Due Date</label>
                    <input type="date" id="equipment-calibration" class="w-full border rounded-lg p-2">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="hideEquipmentModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveEquipment()" class="btn-primary">Save</button>
        </div>
    </div>
</div>

<!-- Type Modal -->
<div id="type-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="type-modal-title">Add Equipment Type</h3>
            <button onclick="hideTypeModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="type-form">
                <input type="hidden" id="type-modal-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                    <input type="text" id="type-name" required class="w-full border rounded-lg p-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="type-description" rows="2" class="w-full border rounded-lg p-2"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="type-manager-notifications" checked class="mr-2">
                    <label for="type-manager-notifications" class="text-sm">Send manager notifications</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="hideTypeModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveType()" class="btn-primary">Save</button>
        </div>
    </div>
</div>

<!-- AI Rule Modal -->
<div id="ai-rule-modal" class="modal-backdrop hidden">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="ai-rule-modal-title">Add AI Rule</h3>
            <button onclick="hideAIRuleModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="ai-rule-form">
                <input type="hidden" id="ai-rule-modal-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rule Type *</label>
                    <select id="ai-rule-type" required class="w-full border rounded-lg p-2" onchange="onRuleTypeChange()">
                        <option value="general">General</option>
                        <option value="parameter">Parameter</option>
                        <option value="example">Example</option>
                    </select>
                </div>
                <div id="parameter-fields" class="grid grid-cols-2 gap-4 mb-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parameter Name</label>
                        <input type="text" id="ai-rule-param-name" class="w-full border rounded-lg p-2" placeholder="e.g., frequency">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="ai-rule-param-unit" class="w-full border rounded-lg p-2" placeholder="e.g., GHz">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prompt Text *</label>
                    <textarea id="ai-rule-prompt" rows="4" required class="w-full border rounded-lg p-2" placeholder="Instructions for the AI..."></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="ai-rule-enabled" checked class="mr-2">
                    <label for="ai-rule-enabled" class="text-sm">Enabled</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="hideAIRuleModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveAIRule()" class="btn-primary">Save</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
// ===============================
// Global State
// ===============================
const userData = {{ user | tojson | safe if user else 'null' }};
const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrf_token='))?.split('=')[1] || '';

let currentSection = 'information';
let allEquipmentData = [];
let allEquipmentTypes = [];
let allUsersData = [];
let selectedEquipmentForBooking = null;
let chatMessages = [];

// ===============================
// API Helper
// ===============================
async function apiCall(url, method = 'GET', body = null) {
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken,
        },
    };
    if (body) options.body = JSON.stringify(body);
    const response = await fetch(url, options);
    return response.json();
}

// ===============================
// Utility Functions
// ===============================
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// ===============================
// Section Navigation
// ===============================
function showSection(sectionName, updateHash = true) {
    // Validate section exists
    const section = document.getElementById('section-' + sectionName);
    if (!section) {
        console.warn(`Section ${sectionName} not found`);
        return;
    }

    // Hide all sections
    document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
    // Remove active from all links
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));

    // Show selected section
    section.classList.remove('hidden');

    // Activate link
    const link = document.querySelector(`[data-section="${sectionName}"]`);
    if (link) link.classList.add('active');

    currentSection = sectionName;

    // Update URL hash (for refresh persistence)
    if (updateHash) {
        window.location.hash = sectionName;
    }

    // Load section data
    if (sectionName === 'information') loadInformation();
    if (sectionName === 'new-booking') loadNewBookingSection();
    if (sectionName === 'reports') loadReports();
    if (sectionName === 'type-access') loadTypeAccessSection();
    if (sectionName === 'user-management') loadUserManagement();
    if (sectionName === 'equipment-management') loadEquipmentManagement();
    if (sectionName === 'cron-jobs') loadCronJobs();
    if (sectionName === 'ai-rules') loadAIRules();
}

// Handle browser back/forward buttons
window.addEventListener('hashchange', () => {
    const section = window.location.hash.slice(1) || 'information';
    showSection(section, false); // Don't update hash again to avoid loop
});

// ===============================
// Information Section
// ===============================
async function loadInformation() {
    // Calculate and display session expiry
    calculateSessionExpiry();

    // Load upcoming bookings
    const data = await apiCall('/api/bookings?user_id=' + (userData?.id || ''));
    const container = document.getElementById('my-bookings-summary');

    const now = new Date().toISOString().split('T')[0];
    const upcoming = (data.bookings || []).filter(b => b.status === 'active' && b.start_date >= now);

    if (upcoming.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No upcoming bookings</p>';
        return;
    }

    // Format time HH:MM
    const formatTime = (timeStr) => {
        if (!timeStr) return '';
        return timeStr.slice(0, 5);
    };

    container.innerHTML = upcoming.map(booking => `
        <div class="border border-brand-200 rounded-lg p-4 bg-white hover:shadow-xl transition-shadow">
            <!-- Equipment and Status -->
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">${escapeHtml(booking.equipment_name || 'Equipment')}</h3>
                    ${booking.equipment_location ? `<p class="text-xs text-gray-500">ðŸ“ ${escapeHtml(booking.equipment_location)}</p>` : ''}
                </div>
                <span class="badge badge-active">Active</span>
            </div>

            <!-- Booking Dates/Times -->
            <div class="flex items-center gap-2 mb-3 text-sm text-gray-600">
                <span>ðŸ“… ${escapeHtml(booking.start_date)} to ${escapeHtml(booking.end_date)}</span>
            </div>
            <div class="flex items-center gap-2 mb-3 text-sm text-gray-600">
                <span>â° ${escapeHtml(formatTime(booking.start_time))} - ${escapeHtml(formatTime(booking.end_time))}</span>
            </div>

            <!-- Booking Notes -->
            ${booking.description ? `<p class="text-sm text-gray-700 mb-3 p-2 bg-yellow-50 rounded border-l-2 border-yellow-300">ðŸ“ ${escapeHtml(booking.description)}</p>` : ''}

            <!-- Actions -->
            <div class="flex gap-4">
                <button class="text-sm text-blue-500 hover:text-blue-700 font-medium transition-colors" onclick="editBookingDescription(${booking.id})">Edit Description</button>
                <button class="text-sm text-red-400 hover:text-red-700 font-medium transition-colors" onclick="cancelBooking(${booking.id})">Cancel Booking</button>
            </div>
        </div>
    `).join('');
}

function calculateSessionExpiry() {
    // This will be populated from cookie or auth token
    // For now, calculate a default 30-day expiry
    const expiryElement = document.getElementById('cookieLifetime');
    if (!expiryElement) return;

    // Try to get expiry from userData if available
    const now = new Date();
    const expiryDate = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days from now

    const msRemaining = expiryDate - now;
    const daysRemaining = Math.floor(msRemaining / (1000 * 60 * 60 * 24));
    const hoursRemaining = Math.floor((msRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    expiryElement.textContent = `${daysRemaining} days, ${hoursRemaining} hours`;
}

async function updateEmailNotificationPreference(enabled) {
    try {
        await apiCall('/api/user/notification-preferences', 'PATCH', {
            email_notifications_enabled: enabled
        });
        showToast('Notification preferences updated', 'success');
    } catch (e) {
        showToast('Failed to update preferences', 'error');
        // Revert the checkbox state
        document.getElementById('emailNotificationsToggle').checked = !enabled;
    }
}

async function editBookingDescription(bookingId) {
    const newDescription = prompt('Enter new description:');
    if (newDescription === null) return; // User cancelled

    try {
        await apiCall(`/api/bookings/${bookingId}/description`, 'PATCH', {
            description: newDescription
        });
        showToast('Description updated', 'success');
        loadInformation();
    } catch (e) {
        showToast('Failed to update description', 'error');
    }
}

async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) return;

    try {
        await apiCall(`/api/bookings/${bookingId}`, 'DELETE');
        showToast('Booking cancelled', 'success');
        loadInformation();
    } catch (e) {
        showToast('Failed to cancel booking', 'error');
    }
}

// ===============================
// New Booking Section
// ===============================
let currentCalendarMonth = new Date();
currentCalendarMonth.setDate(1); // Always use 1st to avoid month overflow bugs
let selectedStartDate = null;
let selectedEndDate = null;
let allBookingsForEquipment = []; // Bookings for selected equipment

async function loadNewBookingSection() {
    // Load equipment
    const eqData = await apiCall('/api/equipment');
    allEquipmentData = eqData.equipment || [];

    // Load types for filter
    const typesData = await apiCall('/api/admin/equipment-types');
    allEquipmentTypes = typesData.types || [];

    // Populate type filter
    const filter = document.getElementById('equipment-type-filter');
    filter.innerHTML = '<option value="all">All Types</option>' +
        allEquipmentTypes.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');

    renderEquipmentGrid();
    // Calendar will be rendered when equipment is selected
}

// Load bookings for selected equipment
async function loadBookingsForEquipment(equipmentId) {
    if (!equipmentId) {
        allBookingsForEquipment = [];
        return;
    }
    const data = await apiCall(`/api/bookings?equipment_id=${equipmentId}`);
    allBookingsForEquipment = (data.bookings || []).filter(b => b.status === 'active');
}

// Generate consistent color for each user (orange spectrum)
function getUserBookingColor(userId) {
    const colorPalette = [
        '#ffb96e', '#ffaa5a', '#ffc885', '#ff9f4a',
        '#ffd199', '#ff8c3a', '#ffe0ad', '#ff7a2a',
        '#ffb380', '#ffa060', '#ffc470', '#ff9550',
    ];
    if (!userId) return colorPalette[0];
    let hash = 0;
    const idStr = String(userId);
    for (let i = 0; i < idStr.length; i++) {
        hash = ((hash << 5) - hash) + idStr.charCodeAt(i);
        hash = hash & hash;
    }
    return colorPalette[Math.abs(hash) % colorPalette.length];
}

// Parse time string (HH:MM) to milliseconds since midnight
function parseTime(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return (hours * 60 + minutes) * 60 * 1000;
}

// Calculate booking duration in hours for a specific date
function getBookingDurationForDate(booking, dateStr) {
    const WORK_DAY_START = '08:00';
    const WORK_DAY_END = '18:00';

    const isSingleDay = booking.start_date === booking.end_date;
    const isFirstDay = dateStr === booking.start_date;
    const isLastDay = dateStr === booking.end_date;

    if (isSingleDay) {
        const start = parseTime(booking.start_time);
        const end = parseTime(booking.end_time);
        return (end - start) / (1000 * 60 * 60);
    }

    if (!isFirstDay && !isLastDay) {
        // Middle day - full work day
        return (parseTime(WORK_DAY_END) - parseTime(WORK_DAY_START)) / (1000 * 60 * 60);
    }

    if (isFirstDay && !isLastDay) {
        const start = parseTime(booking.start_time);
        const endOfWorkDay = parseTime(WORK_DAY_END);
        if (start >= endOfWorkDay) return 0;
        const effectiveStart = Math.max(start, parseTime(WORK_DAY_START));
        return (endOfWorkDay - effectiveStart) / (1000 * 60 * 60);
    }

    if (isLastDay && !isFirstDay) {
        const startOfWorkDay = parseTime(WORK_DAY_START);
        const end = parseTime(booking.end_time);
        if (end <= startOfWorkDay) return 0;
        const effectiveEnd = Math.min(end, parseTime(WORK_DAY_END));
        return (effectiveEnd - startOfWorkDay) / (1000 * 60 * 60);
    }

    return 0;
}

// Get ISO week number
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function renderEquipmentGrid() {
    const container = document.getElementById('equipment-grid');
    const filterValue = document.getElementById('equipment-type-filter').value;

    let filtered = allEquipmentData;
    if (filterValue !== 'all') {
        filtered = allEquipmentData.filter(e => e.type_id == filterValue);
    }

    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-gray-500 col-span-full text-center py-8">No equipment found</div>';
        return;
    }

    container.innerHTML = filtered.map(e => `
        <label class="equipment-card border-2 ${selectedEquipmentForBooking === e.id ? 'border-blue-500 bg-blue-50' : 'border-orange-200'} rounded-lg p-4 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
            <div class="flex items-start gap-3">
                <input type="radio" name="equipment" value="${e.id}" class="mt-1" ${selectedEquipmentForBooking === e.id ? 'checked' : ''}
                    onchange="selectEquipmentForBooking(${e.id}, '${escapeHtml(e.name)}', '${escapeHtml(e.type_name || '')}', '${escapeHtml(e.location || '')}')">
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">${escapeHtml(e.name)}</h3>
                    ${e.description ? `<p class="text-sm text-gray-600 mt-1">${escapeHtml(e.description)}</p>` : ''}
                    <div class="flex items-center gap-2 mt-2">
                        ${e.location ? `<span class="text-xs text-gray-500">ðŸ“ ${escapeHtml(e.location)}</span>` : ''}
                        ${e.type_name ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">${escapeHtml(e.type_name)}</span>` : ''}
                    </div>
                </div>
            </div>
        </label>
    `).join('');
}

function filterEquipment() {
    renderEquipmentGrid();
}

async function selectEquipmentForBooking(id, name, type, location) {
    selectedEquipmentForBooking = id;

    // Update UI
    document.getElementById('selected-equipment-display').classList.remove('hidden');
    document.getElementById('selected-equipment-name').textContent = name;
    document.getElementById('selected-equipment-info').textContent = [type, location].filter(Boolean).join(' â€¢ ') || 'No additional info';

    // Reset date selection when changing equipment
    selectedStartDate = null;
    selectedEndDate = null;

    // Load bookings for this equipment and rebuild calendar
    await loadBookingsForEquipment(id);
    buildCalendar();

    updateBookButton();
    renderEquipmentGrid();
}

function updateBookButton() {
    const btn = document.getElementById('inline-book-btn');
    if (selectedEquipmentForBooking && selectedStartDate && selectedEndDate) {
        btn.disabled = false;
    } else {
        btn.disabled = true;
    }
}

// Build calendar with bookings display
function buildCalendar() {
    const container = document.getElementById('booking-calendar-container');
    if (!selectedEquipmentForBooking) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Select equipment to view calendar</p>';
        return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const firstDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
    const firstDayOfWeek = firstDay.getDay();
    const mondayOffset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    const calendarStart = new Date(firstDay);
    calendarStart.setDate(calendarStart.getDate() - mondayOffset);

    const monthYear = currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    let html = `
        <div class="space-y-4">
            <!-- Month Selector -->
            <div class="flex justify-center items-center gap-4 mb-4">
                <button type="button" class="btn-secondary px-4 py-2" onclick="previousMonth()">â† Previous</button>
                <h4 class="font-semibold text-lg">${monthYear}</h4>
                <button type="button" class="btn-secondary px-4 py-2" onclick="nextMonth()">Next â†’</button>
            </div>

            <!-- Date Range Display -->
            <div class="text-center">
                <span class="text-lg font-bold text-gray-900" id="dateRange">Choose dates</span>
            </div>

            <!-- Calendar Grid -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <div class="grid grid-cols-8 gap-0">
                    <!-- Week Number Header -->
                    <div class="border-b border-gray-200 text-center py-2 font-semibold text-sm text-brand-700" style="background-color: #d9edff;">KW</div>
                    <!-- Weekday Headers -->
                    <div class="bg-gray-100 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Mo</div>
                    <div class="bg-gray-100 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Tu</div>
                    <div class="bg-gray-100 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">We</div>
                    <div class="bg-gray-100 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Th</div>
                    <div class="bg-gray-100 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Fr</div>
                    <div class="bg-yellow-50 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Sa</div>
                    <div class="bg-yellow-50 border-b border-gray-200 text-center py-2 font-semibold text-sm text-gray-700">Su</div>
    `;

    // Generate 6 weeks
    let currentDate = new Date(calendarStart);
    for (let week = 0; week < 6; week++) {
        // Week number cell
        const weekStartDate = new Date(currentDate);
        const weekNumber = getWeekNumber(weekStartDate);
        const year = weekStartDate.getFullYear();
        const month = String(weekStartDate.getMonth() + 1).padStart(2, '0');
        const day = String(weekStartDate.getDate()).padStart(2, '0');
        const weekStartDateStr = `${year}-${month}-${day}`;

        html += `
            <div class="border border-gray-200 p-2 min-h-16 flex items-center justify-center" style="background-color: #e8effa;">
                <button type="button" class="font-semibold text-sm text-brand-700 hover:text-brand-900 cursor-pointer"
                    onclick="selectWeek('${weekStartDateStr}')"
                    title="Click to select working days (Mon-Fri) of week ${weekNumber}">
                    ${weekNumber}
                </button>
            </div>
        `;

        for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
            const dateYear = currentDate.getFullYear();
            const dateMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dayOfMonth = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${dateYear}-${dateMonth}-${dayOfMonth}`;
            const isCurrentMonth = currentDate.getMonth() === currentCalendarMonth.getMonth();
            const isWeekend = dayIdx === 5 || dayIdx === 6;
            const isPast = currentDate < today;

            // Check for bookings on this date
            const bookings = allBookingsForEquipment.filter(b =>
                dateStr >= b.start_date && dateStr <= b.end_date
            );
            const isBooked = bookings.length > 0;

            // Check for partial availability
            let isPartiallyAvailable = false;
            let partialBookingTime = '';

            if (bookings.length > 0) {
                let totalHours = 0;
                let allBookingsArePartial = true;

                for (const booking of bookings) {
                    const duration = getBookingDurationForDate(booking, dateStr);
                    const isFirstDay = dateStr === booking.start_date;
                    const isLastDay = dateStr === booking.end_date;

                    if (!(isFirstDay || isLastDay)) {
                        allBookingsArePartial = false;
                        break;
                    }
                    totalHours += duration;
                }

                if (totalHours < 5 && allBookingsArePartial) {
                    isPartiallyAvailable = true;
                    if (bookings.length === 1) {
                        const booking = bookings[0];
                        if (dateStr === booking.start_date) {
                            partialBookingTime = booking.start_time;
                        } else if (dateStr === booking.end_date) {
                            partialBookingTime = booking.end_time;
                        }
                    } else {
                        partialBookingTime = `${bookings.length}Ã—`;
                    }
                }
            }

            const isFullyBooked = isBooked && !isPartiallyAvailable;
            const isFirstSelected = selectedStartDate === dateStr && !selectedEndDate;
            const isInRange = selectedStartDate && selectedEndDate &&
                dateStr >= selectedStartDate && dateStr <= selectedEndDate;

            let cellClass = 'border border-gray-200 p-2 min-h-16 flex flex-col justify-between cursor-pointer transition-colors relative';
            let dayNumberClass = 'text-sm font-semibold';

            // Background colors
            if (!isCurrentMonth) {
                cellClass += ' bg-gray-50';
                dayNumberClass += ' text-gray-300';
            } else if (isPast) {
                cellClass += ' bg-gray-100';
                dayNumberClass += ' text-gray-400';
            } else if (isPartiallyAvailable) {
                cellClass += ' hover:opacity-90';
                dayNumberClass += ' text-gray-900';
            } else if (isFullyBooked) {
                cellClass += ' hover:opacity-90';
                dayNumberClass += ' text-gray-900';
            } else if (isFirstSelected) {
                cellClass += ' bg-green-700 hover:bg-green-800';
                dayNumberClass += ' text-white';
            } else if (isInRange) {
                cellClass += ' bg-green-600 hover:bg-green-700';
                dayNumberClass += ' text-white';
            } else if (isWeekend && isCurrentMonth) {
                cellClass += ' bg-yellow-50 hover:bg-yellow-100';
                dayNumberClass += ' text-gray-900';
            } else {
                cellClass += ' bg-white hover:bg-green-50';
                dayNumberClass += ' text-gray-900';
            }

            // User name for booked cells
            let userNameHtml = '';
            if (isFullyBooked && bookings[0]) {
                const userName = bookings[0].user_name || 'Unknown';
                const nameParts = userName.trim().split(/\s+/);
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                const firstTrimmed = firstName.length > 10 ? firstName.substring(0, 9) + 'â€¦' : firstName;
                const lastTrimmed = lastName.length > 10 ? lastName.substring(0, 9) + 'â€¦' : lastName;
                userNameHtml = `<span class="text-xs leading-tight hidden md:block" style="font-size: 0.65rem; line-height: 1.1;">${escapeHtml(firstTrimmed)}<br>${escapeHtml(lastTrimmed)}</span>`;
            }

            // Time display for partial bookings
            let timeDisplayHtml = '';
            if (isPartiallyAvailable && partialBookingTime) {
                timeDisplayHtml = `<span class="text-xs text-gray-600 mt-1">${partialBookingTime}</span>`;
            }

            // Tooltip
            const tooltipText = (isFullyBooked || isPartiallyAvailable) && bookings[0]
                ? escapeHtml(`${bookings[0].user_name || 'Unknown'} - ${bookings[0].start_time} to ${bookings[0].end_time}${bookings[0].description ? ' - ' + bookings[0].description.substring(0, 50) : ''}`)
                : '';

            // Cell style and selectability
            let cellStyle = '';
            let cellOnclick = '';
            let cellDisabled = '';
            const canSelectNow = isCurrentMonth && !isPast;

            if (isPartiallyAvailable) {
                cellStyle = 'background-color: #F0E68C;';
                cellOnclick = `onclick="selectDate('${dateStr}')"`;
            } else if (isFullyBooked) {
                const bookedColor = bookings[0] ? getUserBookingColor(bookings[0].user_id) : '#ffb96e';
                cellStyle = `background-color: ${bookedColor}; cursor: not-allowed;`;
                cellDisabled = 'disabled';
            } else if (canSelectNow) {
                cellOnclick = `onclick="selectDate('${dateStr}')"`;
            } else {
                cellStyle = 'cursor: not-allowed;';
                cellDisabled = 'disabled';
            }

            html += `
                <button type="button" class="${cellClass}"
                    ${cellStyle ? `style="${cellStyle}"` : ''}
                    ${cellOnclick}
                    ${cellDisabled}
                    title="${tooltipText}">
                    <span class="${dayNumberClass}">${currentDate.getDate()}</span>
                    ${timeDisplayHtml}
                    ${userNameHtml}
                </button>
            `;

            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    html += `
                </div>
            </div>

            <!-- Legend -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                <span class="flex items-center gap-2"><span class="w-4 h-4 bg-green-600 rounded"></span>Selected Range</span>
                <span class="flex items-center gap-2"><span class="w-4 h-4 rounded border border-gray-300" style="background-color: #F0E68C;"></span>Partially Available (&lt;5h)</span>
                <span class="flex items-center gap-2"><span class="w-4 h-4 rounded border border-gray-300" style="background-color: #ffb96e;"></span>Fully Booked</span>
                <span class="flex items-center gap-2"><span class="w-4 h-4 bg-yellow-50 rounded border border-yellow-200"></span>Weekend</span>
            </div>
        </div>
    `;

    container.innerHTML = html;
    updateDateDisplay();
}

// Previous month
function previousMonth() {
    currentCalendarMonth.setDate(1);
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
    buildCalendar();
}

// Next month
function nextMonth() {
    currentCalendarMonth.setDate(1);
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
    buildCalendar();
}

// Select date range
function selectDate(dateStr) {
    if (!selectedStartDate) {
        selectedStartDate = dateStr;
    } else if (!selectedEndDate) {
        const date1 = new Date(selectedStartDate);
        const date2 = new Date(dateStr);

        if (date2 >= date1) {
            selectedEndDate = dateStr;
        } else {
            selectedEndDate = selectedStartDate;
            selectedStartDate = dateStr;
        }
    } else {
        selectedStartDate = dateStr;
        selectedEndDate = null;
    }

    buildCalendar();
    updateBookButton();
}

// Select all working days (Mon-Fri) of a week
function selectWeek(weekStartDate) {
    if (!selectedEquipmentForBooking) {
        showToast('Please select equipment first', 'warning');
        return;
    }

    const startDate = new Date(weekStartDate);
    const workingDays = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < 5; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;

        const isCurrentMonth = date.getMonth() === currentCalendarMonth.getMonth();
        const isPast = date < today;
        const bookings = allBookingsForEquipment.filter(b =>
            dateStr >= b.start_date && dateStr <= b.end_date
        );
        const isBooked = bookings.length > 0;

        if (isCurrentMonth && !isPast && !isBooked) {
            workingDays.push(dateStr);
        }
    }

    if (workingDays.length === 0) {
        showToast('No available working days in this week', 'warning');
        return;
    }

    selectedStartDate = workingDays[0];
    selectedEndDate = workingDays[workingDays.length - 1];

    buildCalendar();
    updateBookButton();
}

// Update date display
function updateDateDisplay() {
    const rangeEl = document.getElementById('dateRange');
    if (!rangeEl) return;

    if (selectedStartDate && selectedEndDate) {
        rangeEl.textContent = `${selectedStartDate} to ${selectedEndDate}`;
    } else if (selectedStartDate) {
        rangeEl.textContent = selectedStartDate;
    } else {
        rangeEl.textContent = 'Choose dates';
    }
}

function toggleCard(cardId) {
    const content = document.getElementById(cardId + 'Content');
    const toggle = document.getElementById(cardId + 'Toggle');
    if (!content || !toggle) return;

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        toggle.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('hidden');
        toggle.style.transform = 'rotate(-90deg)';
    }
}

function updateDescCharCount() {
    const textarea = document.getElementById('inline-description');
    const counter = document.getElementById('desc-char-count');
    counter.textContent = `${textarea.value.length} / 10,240`;
}

async function submitBooking() {
    if (!selectedEquipmentForBooking) {
        showToast('Please select equipment first', 'warning');
        return;
    }
    if (!selectedStartDate || !selectedEndDate) {
        showToast('Please select dates on the calendar', 'warning');
        return;
    }

    const body = {
        equipment_id: selectedEquipmentForBooking,
        start_date: selectedStartDate,
        end_date: selectedEndDate,
        start_time: document.getElementById('inline-start-time').value + ':00',
        end_time: document.getElementById('inline-end-time').value + ':00',
        description: document.getElementById('inline-description').value,
    };

    const data = await apiCall('/api/bookings', 'POST', body);

    if (data.success) {
        showToast('Booking created successfully!', 'success');
        resetBookingForm();
    } else {
        const msgEl = document.getElementById('booking-message');
        msgEl.classList.remove('hidden');
        msgEl.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-800';
        msgEl.textContent = data.detail?.message || data.detail || 'Failed to create booking';
    }
}

function resetBookingForm() {
    selectedEquipmentForBooking = null;
    selectedStartDate = null;
    selectedEndDate = null;
    allBookingsForEquipment = [];

    document.getElementById('selected-equipment-display').classList.add('hidden');
    document.getElementById('inline-start-time').value = '08:00';
    document.getElementById('inline-end-time').value = '18:00';
    document.getElementById('inline-description').value = '';
    document.getElementById('desc-char-count').textContent = '0 / 10,240';
    document.getElementById('booking-message').classList.add('hidden');

    updateBookButton();
    renderEquipmentGrid();
    buildCalendar();
}

// ===============================
// AI Assistant Section
// ===============================
function setAIPrompt(text) {
    document.getElementById('ai-prompt').value = text;
    updateAICharCount();
}

function updateAICharCount() {
    const textarea = document.getElementById('ai-prompt');
    const counter = document.getElementById('ai-char-count');
    counter.textContent = `${textarea.value.length} / 500`;
}

function clearAIPrompt() {
    document.getElementById('ai-prompt').value = '';
    updateAICharCount();
}

function handleAIKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        askAI();
    }
}

function newAISearch() {
    document.getElementById('ai-results').classList.add('hidden');
    document.getElementById('ai-error').classList.add('hidden');
    document.getElementById('ai-prompt').value = '';
    updateAICharCount();
    document.getElementById('ai-prompt').focus();
}

async function askAI() {
    const prompt = document.getElementById('ai-prompt').value.trim();
    if (!prompt) {
        showToast('Please enter a request', 'warning');
        return;
    }

    const searchDays = document.getElementById('ai-search-days').value || 30;
    const loadingEl = document.getElementById('ai-loading');
    const errorEl = document.getElementById('ai-error');
    const resultsEl = document.getElementById('ai-results');
    const recommendationsEl = document.getElementById('ai-recommendations');
    const explanationEl = document.getElementById('ai-explanation');

    // Hide previous states
    resultsEl.classList.add('hidden');
    errorEl.classList.add('hidden');

    // Show loading
    loadingEl.classList.remove('hidden');

    try {
        const data = await apiCall('/api/ai/analyze', 'POST', {
            prompt,
            search_days: parseInt(searchDays)
        });

        loadingEl.classList.add('hidden');

        if (data.error) {
            errorEl.classList.remove('hidden');
            document.getElementById('ai-error-message').textContent = data.error;
            return;
        }

        if (data.recommendations?.length) {
            explanationEl.textContent = data.explanation || '';
            recommendationsEl.innerHTML = data.recommendations.map(r => `
                <div class="p-4 border-2 border-gray-200 rounded-lg hover:border-orange-300 transition-all">
                    <h4 class="font-semibold text-gray-800">${escapeHtml(r.name)}</h4>
                    <p class="text-gray-600 text-sm mt-1">${escapeHtml(r.reasoning || 'Recommended by AI')}</p>
                    ${r.available_dates ? `<p class="text-xs text-gray-500 mt-2">Available: ${r.available_dates}</p>` : ''}
                    <button onclick="selectEquipmentFromAI(${r.equipment_id})" class="mt-3 text-orange-600 hover:text-orange-800 font-medium text-sm">
                        Book this equipment â†’
                    </button>
                </div>
            `).join('');
            resultsEl.classList.remove('hidden');
        } else {
            errorEl.classList.remove('hidden');
            document.getElementById('ai-error-message').textContent = 'No matching equipment found. Try describing your requirements differently.';
        }
    } catch (e) {
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        document.getElementById('ai-error-message').textContent = 'Failed to get AI recommendations. Please try again.';
    }
}

function selectEquipmentFromAI(equipmentId) {
    selectedEquipmentForBooking = equipmentId;
    const eq = allEquipmentData.find(e => e.id === equipmentId);
    if (eq) {
        showSection('new-booking');
        setTimeout(() => selectEquipmentForBooking(eq.id, eq.name, eq.type_name, eq.location), 100);
    }
}

// ===============================
// Reports Section
// ===============================
// Toggle collapsible sections
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + 'Content');
    const toggle = document.getElementById(sectionId + 'Toggle');

    if (content && toggle) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.style.transform = 'rotate(0deg)';
        } else {
            content.style.display = 'none';
            toggle.style.transform = 'rotate(-90deg)';
        }
    }
}

// Apply booking filter
function applyBookingFilter() {
    loadBookingHistory();
}

// Load booking history
async function loadBookingHistory() {
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;

    let url = '/api/bookings?status=completed';
    if (startDate) url += `&start_date=${startDate}`;
    if (endDate) url += `&end_date=${endDate}`;

    const bookings = await apiCall(url);
    const container = document.getElementById('bookingHistoryList');

    if (bookings.bookings?.length) {
        container.innerHTML = bookings.bookings.map(b => `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="font-semibold text-gray-800">${escapeHtml(b.equipment_name || 'Equipment')}</div>
                <div class="text-sm text-gray-600 mt-1">${b.start_date} - ${b.end_date}</div>
                <div class="text-sm text-gray-500 mt-1">${b.start_time || ''} - ${b.end_time || ''}</div>
                <div class="mt-2">
                    <span class="badge ${b.status === 'completed' ? 'status-completed' : b.status === 'active' ? 'status-active' : 'status-cancelled'}">${b.status}</span>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm col-span-full">No bookings found</div>';
    }
}

async function loadReports() {
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;

    let statsUrl = '/api/reports/booking-stats';
    let usageUrl = '/api/reports/equipment-usage';
    let userActivityUrl = '/api/reports/user-activity';

    if (startDate || endDate) {
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        statsUrl += '?' + params.toString();
        usageUrl += '?' + params.toString();
        userActivityUrl += '?' + params.toString();
    }

    const [stats, usage, equipment, users, userActivity] = await Promise.all([
        apiCall(statsUrl),
        apiCall(usageUrl),
        apiCall('/api/equipment'),
        apiCall('/api/admin/users'),
        apiCall(userActivityUrl)
    ]);

    // Populate Stats Cards
    const statsContainer = document.getElementById('statsCardsContainer');
    const totalBookings = stats.summary?.total || 0;
    const activeBookings = stats.summary?.active || 0;
    const equipmentCount = equipment.equipment?.length || 0;
    const activeUsers = users.users?.filter(u => u.is_active).length || 0;
    const totalHours = stats.summary?.total_hours || 0;

    statsContainer.innerHTML = `
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="text-3xl font-bold text-gray-800">${totalBookings}</div>
                <div class="text-sm text-gray-500">Total Bookings</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="text-3xl font-bold text-green-600">${activeBookings}</div>
                <div class="text-sm text-gray-500">Active</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="text-3xl font-bold text-blue-600">${equipmentCount}</div>
                <div class="text-sm text-gray-500">Equipment</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="text-3xl font-bold text-purple-600">${activeUsers}</div>
                <div class="text-sm text-gray-500">Active Users</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body text-center py-4">
                <div class="text-3xl font-bold text-orange-600">${totalHours}</div>
                <div class="text-sm text-gray-500">Total Hours</div>
            </div>
        </div>
    `;

    // Populate Equipment Utilization Table
    const utilizationBody = document.getElementById('equipmentUtilizationBody');
    if (usage.equipment?.length) {
        utilizationBody.innerHTML = usage.equipment.map(e => {
            const pct = Math.min(100, (e.total_bookings || 0) * 10);
            const color = pct > 70 ? 'green' : pct > 30 ? 'yellow' : 'red';
            return `
                <tr>
                    <td class="py-3">${escapeHtml(e.name)}</td>
                    <td class="py-3">${escapeHtml(e.location || '-')}</td>
                    <td class="py-3 text-right">${e.total_bookings || 0}</td>
                    <td class="py-3 text-right">${e.total_hours || 0}</td>
                    <td class="py-3">
                        <div class="flex items-center gap-2">
                            <div class="progress-bar flex-1">
                                <div class="progress-bar-fill ${color}" style="width: ${pct}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-10">${pct}%</span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        utilizationBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No utilization data</td></tr>';
    }

    // Populate User Activity Table
    const userActivityBody = document.getElementById('userActivityBody');
    if (userActivity.users?.length) {
        userActivityBody.innerHTML = userActivity.users.map(u => `
            <tr>
                <td class="py-3">${escapeHtml(u.name || u.email)}</td>
                <td class="py-3 text-right">${u.active_bookings || 0}</td>
                <td class="py-3 text-right">${u.cancelled_bookings || 0}</td>
                <td class="py-3 text-right">${u.completed_bookings || 0}</td>
                <td class="py-3 text-right">${(u.avg_hours_per_booking || 0).toFixed(1)}</td>
                <td class="py-3 text-right">${u.total_hours || 0}</td>
            </tr>
        `).join('');
    } else {
        userActivityBody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No user activity data</td></tr>';
    }

    // Populate Top Equipment
    const topEquipmentContainer = document.getElementById('topEquipmentContainer');
    const sortedEquipment = (usage.equipment || [])
        .sort((a, b) => (b.total_bookings || 0) - (a.total_bookings || 0))
        .slice(0, 10);

    if (sortedEquipment.length) {
        topEquipmentContainer.innerHTML = sortedEquipment.map((e, i) => `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-sm">${i + 1}</div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">${escapeHtml(e.name)}</div>
                        <div class="text-sm text-gray-500">${escapeHtml(e.location || 'No location')}</div>
                    </div>
                </div>
                <div class="mt-3 flex justify-between text-sm">
                    <span class="text-gray-600">${e.total_bookings || 0} bookings</span>
                    <span class="text-gray-600">${e.total_hours || 0} hours</span>
                </div>
            </div>
        `).join('');
    } else {
        topEquipmentContainer.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm col-span-full">No equipment data</div>';
    }

    // Also load booking history
    loadBookingHistory();
}

function exportReportsCSV() {
    showToast('Export feature coming soon', 'info');
}

// ===============================
// Type Access Section (Manager)
// ===============================
async function loadTypeAccessSection() {
    const typesData = await apiCall('/api/admin/equipment-types');
    const filter = document.getElementById('type-access-filter');
    filter.innerHTML = '<option value="">Select Equipment Type...</option>' +
        (typesData.types || []).map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
}

async function loadTypeAccess() {
    const typeId = document.getElementById('type-access-filter').value;
    const container = document.getElementById('type-access-table');

    if (!typeId) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">Select an equipment type to manage access</div>';
        return;
    }

    const users = await apiCall('/api/admin/users');
    const typeUsers = await apiCall(`/api/equipment-types/${typeId}/users`);
    const grantedUserIds = new Set((typeUsers.users || []).map(u => u.id));

    container.innerHTML = `
        <table class="w-full">
            <thead>
                <tr>
                    <th class="text-left">User</th>
                    <th class="text-left">Email</th>
                    <th class="text-left">Role</th>
                    <th class="text-center">Has Access</th>
                </tr>
            </thead>
            <tbody>
                ${(users.users || []).map(u => `
                    <tr>
                        <td>${escapeHtml(u.name)}</td>
                        <td>${escapeHtml(u.email)}</td>
                        <td><span class="role-badge role-badge-${u.role_name?.toLowerCase()}">${u.role_name}</span></td>
                        <td class="text-center">
                            <div class="toggle-switch ${grantedUserIds.has(u.id) ? 'active' : ''}"
                                 onclick="toggleTypeAccess(${typeId}, ${u.id}, ${!grantedUserIds.has(u.id)})"></div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

async function toggleTypeAccess(typeId, userId, grant) {
    const endpoint = grant
        ? `/api/equipment-types/${typeId}/users/${userId}/grant`
        : `/api/equipment-types/${typeId}/users/${userId}/revoke`;
    const method = grant ? 'POST' : 'DELETE';

    const result = await apiCall(endpoint, method);
    if (result.success) {
        showToast(grant ? 'Access granted' : 'Access revoked', 'success');
        loadTypeAccess();
    } else {
        showToast('Failed to update access', 'error');
    }
}

// ===============================
// User Management Section (Admin)
// ===============================
let registrationSettings = null;
let allowedEmailsData = [];
let parsedImportEmails = [];

async function loadUserManagement() {
    // Load users
    const users = await apiCall('/api/admin/users');
    allUsersData = users.users || [];

    // Sort: active users first, then alphabetical by name
    allUsersData.sort((a, b) => {
        if (a.is_active !== b.is_active) return b.is_active - a.is_active;
        return (a.name || '').localeCompare(b.name || '');
    });

    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = allUsersData.map(u => {
        const lastLogin = u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never';
        const statusBadge = u.is_active
            ? '<span class="badge status-active">Active</span>'
            : '<span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-gray-200 text-gray-600">Inactive</span>';
        const roleBadgeClass = {
            'admin': 'badge-admin',
            'manager': 'badge-manager',
            'user': 'badge-user'
        }[u.role_name?.toLowerCase()] || 'badge-user';

        return `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4 font-medium text-gray-900">${escapeHtml(u.email)}</td>
                <td class="py-3 px-4 text-gray-600">${escapeHtml(u.name)}</td>
                <td class="py-3 px-4">
                    <span class="badge ${roleBadgeClass}">
                        ${escapeHtml((u.role_name || 'user').charAt(0).toUpperCase() + (u.role_name || 'user').slice(1))}
                    </span>
                </td>
                <td class="py-3 px-4">${statusBadge}</td>
                <td class="py-3 px-4 text-gray-600 text-sm">${lastLogin}</td>
                <td class="py-3 px-4">
                    <div class="flex gap-2">
                        <button onclick="openRoleModal(${u.id}, '${escapeHtml(u.name)}', '${escapeHtml(u.role_name || 'user')}')"
                            class="text-orange-600 hover:text-orange-800 text-sm font-medium">
                            Change Role
                        </button>
                        <button onclick="toggleUserStatus(${u.id}, ${u.is_active})"
                            class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                            ${u.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // Load registration settings
    await loadRegistrationSettings();

    // Load service mode status
    await loadServiceModeStatus();
}

// Registration Settings
async function loadRegistrationSettings() {
    try {
        const result = await apiCall('/api/admin/registration-settings');
        if (result.success) {
            registrationSettings = result;

            // Update toggles
            document.getElementById('domainRegistrationToggle').checked = result.allow_domain_registration;
            document.getElementById('emailRegistrationToggle').checked = result.allow_email_registration;

            // Populate domain input
            const domainInput = document.getElementById('allowedDomainsInput');
            if (domainInput) {
                domainInput.value = result.domain || '';
            }

            // Show/hide email import section based on email registration toggle
            const emailSection = document.getElementById('emailImportSection');
            if (result.allow_email_registration) {
                emailSection.classList.remove('hidden');
                await loadAllowedEmails();
            } else {
                emailSection.classList.add('hidden');
            }
        } else {
            console.error('Failed to load registration settings:', result);
        }
    } catch (error) {
        console.error('Error loading registration settings:', error);
    }
}

async function updateRegistrationSettings() {
    const domainEnabled = document.getElementById('domainRegistrationToggle').checked;
    const emailEnabled = document.getElementById('emailRegistrationToggle').checked;

    // Validate: at least one must be enabled
    if (!domainEnabled && !emailEnabled) {
        showToast('At least one registration method must be enabled', 'error');
        // Revert the toggle
        setTimeout(() => loadRegistrationSettings(), 100);
        return;
    }

    try {
        const result = await apiCall('/api/admin/registration-settings', 'PUT', {
            allow_domain_registration: domainEnabled,
            allow_email_registration: emailEnabled
        });

        if (result.success) {
            showToast('Registration settings updated', 'success');
            await loadRegistrationSettings();
        } else {
            showToast(result.detail || 'Failed to update settings', 'error');
            await loadRegistrationSettings(); // Revert toggles
        }
    } catch (error) {
        showToast('Failed to update settings: ' + error.message, 'error');
        await loadRegistrationSettings(); // Revert toggles
    }
}

async function saveDomainSettings() {
    const domainInput = document.getElementById('allowedDomainsInput');
    const domains = domainInput.value.trim();

    if (!domains) {
        showToast('Please enter at least one domain', 'error');
        return;
    }

    // Parse and clean domains
    const domainList = domains.split(',').map(d => d.trim().toLowerCase()).filter(d => d);

    // Validate domain format
    for (const domain of domainList) {
        if (!domain.includes('.') || domain.includes('@')) {
            showToast(`Invalid domain format: "${domain}". Enter domain without @ (e.g., company.com)`, 'error');
            return;
        }
    }

    try {
        const result = await apiCall('/api/admin/registration-settings', 'PUT', {
            allowed_domains: domainList
        });

        if (result.success) {
            showToast('Domain settings saved', 'success');
            await loadRegistrationSettings();
        } else {
            showToast(result.detail || 'Failed to save domain settings', 'error');
        }
    } catch (error) {
        showToast('Failed to save domain settings: ' + error.message, 'error');
    }
}

// Allowed Emails Management
async function loadAllowedEmails() {
    const result = await apiCall('/api/admin/registration/allowed-emails');
    if (result.success) {
        allowedEmailsData = result.emails || [];
        document.getElementById('allowedEmailsCount').textContent = allowedEmailsData.length;

        const tbody = document.getElementById('allowedEmailsTableBody');
        if (allowedEmailsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No allowed emails yet. Click "Import Emails" to add.</td></tr>';
            return;
        }

        tbody.innerHTML = allowedEmailsData.map(e => {
            const statusBadge = e.status === 'registered'
                ? '<span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Registered</span>'
                : '<span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
            const invitedDate = e.invited_at ? new Date(e.invited_at).toLocaleDateString() : '-';
            const canRemove = e.status !== 'registered';

            return `
                <tr class="hover:bg-gray-50">
                    <td class="py-3 px-4 font-mono text-sm">${escapeHtml(e.email)}</td>
                    <td class="py-3 px-4">${escapeHtml(e.name || '-')}</td>
                    <td class="py-3 px-4">${statusBadge}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${invitedDate}</td>
                    <td class="py-3 px-4">
                        ${canRemove ? `<button onclick="removeAllowedEmail(${e.id})" class="text-red-600 hover:text-red-800 text-sm">Remove</button>` : '<span class="text-gray-400 text-sm">-</span>'}
                    </td>
                </tr>
            `;
        }).join('');
    }
}

async function removeAllowedEmail(emailId) {
    if (!confirm('Remove this email from the allowlist?')) return;

    const result = await apiCall(`/api/admin/registration/allowed-emails/${emailId}`, 'DELETE');
    if (result.success) {
        showToast('Email removed from allowlist', 'success');
        await loadAllowedEmails();
    } else {
        showToast(result.detail || 'Failed to remove email', 'error');
    }
}

// Import Emails Modal
function openImportEmailsModal() {
    document.getElementById('importEmailsTextarea').value = '';
    document.getElementById('importPreviewSection').classList.add('hidden');
    document.getElementById('importErrorSection').classList.add('hidden');
    parsedImportEmails = [];
    document.getElementById('importEmailsModalOverlay').classList.remove('hidden');
}

function closeImportEmailsModal() {
    document.getElementById('importEmailsModalOverlay').classList.add('hidden');
}

function previewImportEmails() {
    const textarea = document.getElementById('importEmailsTextarea');
    const lines = textarea.value.split('\n').filter(line => line.trim());

    parsedImportEmails = [];
    const errors = [];

    lines.forEach((line, idx) => {
        const parts = line.split(',').map(p => p.trim());
        const email = parts[0]?.toLowerCase();
        const name = parts[1] || '';

        if (!email) return;

        // Basic email validation
        if (!email.includes('@') || !email.includes('.')) {
            errors.push(`Line ${idx + 1}: Invalid email format "${email}"`);
            return;
        }

        parsedImportEmails.push({ email, name });
    });

    // Show errors if any
    const errorSection = document.getElementById('importErrorSection');
    const errorList = document.getElementById('importErrorList');
    if (errors.length > 0) {
        errorList.innerHTML = errors.map(e => `<li>${escapeHtml(e)}</li>`).join('');
        errorSection.classList.remove('hidden');
    } else {
        errorSection.classList.add('hidden');
    }

    // Show preview
    const previewSection = document.getElementById('importPreviewSection');
    const previewCount = document.getElementById('importPreviewCount');
    const previewBody = document.getElementById('importPreviewTableBody');

    if (parsedImportEmails.length > 0) {
        previewCount.textContent = parsedImportEmails.length;
        previewBody.innerHTML = parsedImportEmails.map(e => `
            <tr>
                <td class="py-2 px-3 font-mono text-sm">${escapeHtml(e.email)}</td>
                <td class="py-2 px-3">${escapeHtml(e.name || '-')}</td>
                <td class="py-2 px-3"><span class="text-green-600">Ready</span></td>
            </tr>
        `).join('');
        previewSection.classList.remove('hidden');
    } else {
        previewSection.classList.add('hidden');
    }
}

async function confirmImportEmails() {
    if (parsedImportEmails.length === 0) {
        previewImportEmails();
        if (parsedImportEmails.length === 0) {
            showToast('No valid emails to import', 'error');
            return;
        }
    }

    const result = await apiCall('/api/admin/registration/allowed-emails/import', 'POST', {
        emails: parsedImportEmails
    });

    if (result.success) {
        showToast(`Imported ${result.added} emails, updated ${result.updated || 0}, skipped ${result.skipped}`, 'success');
        closeImportEmailsModal();
        await loadAllowedEmails();
    } else {
        showToast(result.detail || 'Failed to import emails', 'error');
    }
}

// Service Mode
async function loadServiceModeStatus() {
    const result = await apiCall('/api/admin/service-mode');
    if (result.success) {
        document.getElementById('serviceModeToggle').checked = result.enabled;
    }
}

async function toggleServiceMode() {
    const toggle = document.getElementById('serviceModeToggle');
    const newState = toggle.checked;

    if (newState) {
        if (!confirm('âš ï¸ Enable Service Mode?\n\nOnly administrators will be able to log in. All other users will be prevented from accessing the system.\n\nAre you sure?')) {
            toggle.checked = false;
            return;
        }
    }

    const result = await apiCall('/api/admin/service-mode', 'PUT', { enabled: newState });
    if (result.success) {
        showToast(newState ? 'Service mode enabled' : 'Service mode disabled', 'success');
    } else {
        showToast(result.detail || 'Failed to update service mode', 'error');
        toggle.checked = !newState; // Revert
    }
}

// Token Management
async function deleteOldTokens() {
    const daysInput = document.getElementById('tokenAgeDays');
    const days = parseInt(daysInput.value);

    // Validate input (0-180 range)
    if (isNaN(days) || days < 0 || days > 180) {
        showToast('Please enter a valid number of days between 0 and 180', 'error');
        return;
    }

    const confirmMsg = `âš ï¸ WARNING: This will delete all authentication tokens older than ${days} days.\n\nAffected users will need to request a new registration link to access the system.\n\nAre you sure you want to proceed?`;

    if (!confirm(confirmMsg)) return;

    const result = await apiCall('/api/admin/tokens/delete-old', 'POST', { days });

    if (result.success) {
        showToast(`Deleted ${result.deleted_count} tokens. ${result.affected_users} users affected.`, 'success');
    } else {
        showToast(result.detail || 'Failed to delete tokens', 'error');
    }
}

// Role Modal Functions (enhanced)
function openRoleModal(userId, userName, currentRole) {
    document.getElementById('role-modal-user-id').value = userId;

    // Pre-check the current role
    const roleValue = { 'admin': '1', 'manager': '2', 'user': '3' }[currentRole.toLowerCase()] || '3';
    const radio = document.querySelector(`input[name="new-role"][value="${roleValue}"]`);
    if (radio) radio.checked = true;

    document.getElementById('role-modal').classList.remove('hidden');
}

function showRoleModal(userId, currentRoleId) {
    document.getElementById('role-modal-user-id').value = userId;
    document.querySelector(`input[name="new-role"][value="${currentRoleId}"]`).checked = true;
    document.getElementById('role-modal').classList.remove('hidden');
}

function hideRoleModal() {
    document.getElementById('role-modal').classList.add('hidden');
}

async function saveUserRole() {
    const userId = document.getElementById('role-modal-user-id').value;
    const newRole = document.querySelector('input[name="new-role"]:checked').value;

    const result = await apiCall(`/api/admin/users/${userId}/role`, 'PUT', { role_id: parseInt(newRole) });
    if (result.success) {
        showToast('Role updated', 'success');
        hideRoleModal();
        loadUserManagement();
    } else {
        showToast(result.detail || 'Failed to update role', 'error');
    }
}

async function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;

    const result = await apiCall(`/api/admin/users/${userId}/status`, 'PUT', { is_active: !isActive });
    if (result.success) {
        showToast(isActive ? 'User deactivated' : 'User activated', 'success');
        loadUserManagement();
    } else {
        showToast(result.detail || 'Failed to update status', 'error');
    }
}

// ===============================
// Equipment Management Section (Admin)
// ===============================
async function loadEquipmentManagement() {
    const [eqData, typesData] = await Promise.all([
        apiCall('/api/equipment?include_inactive=true'),
        apiCall('/api/admin/equipment-types')
    ]);

    allEquipmentData = eqData.equipment || [];
    allEquipmentTypes = typesData.types || [];

    // Render types with item counts and aligned styling
    const typesList = document.getElementById('types-list');
    typesList.innerHTML = allEquipmentTypes.map(t => {
        const count = allEquipmentData.filter(e => e.type_id === t.id).length;
        return `
            <div class="border border-brand-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="font-semibold text-gray-900">${escapeHtml(t.name)}</h3>
                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${count} items</span>
                </div>
                ${t.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(t.description)}</p>` : ''}
                <div class="flex gap-2">
                    <button onclick="showTypeModal(${t.id})" class="text-xs text-brand-600 hover:text-brand-700 font-medium transition-colors">Edit</button>
                    ${count === 0
                        ? `<button onclick="deleteEquipmentType(${t.id})" class="text-xs text-red-600 hover:text-red-700 font-medium transition-colors">Delete</button>`
                        : `<span class="text-xs text-gray-500">Cannot delete (${count} items)</span>`
                    }
                </div>
            </div>
        `;
    }).join('');

    // Render equipment table with Deactivate/Activate actions
    const tbody = document.getElementById('equipment-table-body');
    tbody.innerHTML = allEquipmentData.map(e => `
        <tr class="hover:bg-gray-50">
            <td class="py-3 px-4">
                <div class="font-medium text-gray-900">${escapeHtml(e.name)}</div>
                <div class="text-xs text-gray-500">${escapeHtml(e.description?.slice(0, 50) || '')}${e.description?.length > 50 ? '...' : ''}</div>
            </td>
            <td class="py-3 px-4 text-gray-600">${escapeHtml(e.location || '-')}</td>
            <td class="py-3 px-4"><span class="badge badge-user text-xs">${escapeHtml(e.type_name || 'No type')}</span></td>
            <td class="py-3 px-4 text-center">${e.managers?.length || 0}</td>
            <td class="py-3 px-4 text-center">
                ${e.is_active
                    ? '<span class="badge status-active">Active</span>'
                    : '<span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-gray-200 text-gray-600">Not Active</span>'
                }
            </td>
            <td class="py-3 px-4 text-right">
                <div class="flex gap-2 justify-end">
                    <button onclick="showEquipmentModal(${e.id})" class="text-xs text-gray-600 hover:text-gray-700 font-medium transition-colors">Edit</button>
                    ${e.is_active
                        ? `<button onclick="toggleEquipmentStatus(${e.id}, 0)" class="text-xs text-red-600 hover:text-red-700 font-medium transition-colors">Deactivate</button>`
                        : `<button onclick="toggleEquipmentStatus(${e.id}, 1)" class="text-xs text-green-600 hover:text-green-700 font-medium transition-colors">Activate</button>`
                    }
                </div>
            </td>
        </tr>
    `).join('');
}

function showEquipmentModal(equipmentId = null) {
    const modal = document.getElementById('equipment-modal');
    const title = document.getElementById('equipment-modal-title');
    const form = document.getElementById('equipment-form');
    const typeSelect = document.getElementById('equipment-type');

    // Populate type dropdown
    typeSelect.innerHTML = '<option value="">No type</option>' +
        allEquipmentTypes.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');

    if (equipmentId) {
        title.textContent = 'Edit Equipment';
        const eq = allEquipmentData.find(e => e.id === equipmentId);
        if (eq) {
            document.getElementById('equipment-modal-id').value = equipmentId;
            document.getElementById('equipment-name').value = eq.name || '';
            document.getElementById('equipment-description').value = eq.description || '';
            document.getElementById('equipment-location').value = eq.location || '';
            document.getElementById('equipment-type').value = eq.type_id || '';
            document.getElementById('equipment-calibration').value = eq.next_calibration_date || '';
        }
    } else {
        title.textContent = 'Add Equipment';
        form.reset();
        document.getElementById('equipment-modal-id').value = '';
    }

    modal.classList.remove('hidden');
}

function hideEquipmentModal() {
    document.getElementById('equipment-modal').classList.add('hidden');
}

async function saveEquipment() {
    const id = document.getElementById('equipment-modal-id').value;
    const body = {
        name: document.getElementById('equipment-name').value,
        description: document.getElementById('equipment-description').value,
        location: document.getElementById('equipment-location').value,
        type_id: document.getElementById('equipment-type').value || null,
        next_calibration_date: document.getElementById('equipment-calibration').value || null,
    };

    const url = id ? `/api/equipment/${id}` : '/api/equipment';
    const method = id ? 'PUT' : 'POST';

    const result = await apiCall(url, method, body);
    if (result.success || result.equipment) {
        showToast(id ? 'Equipment updated' : 'Equipment created', 'success');
        hideEquipmentModal();
        loadEquipmentManagement();
    } else {
        showToast(result.detail || 'Failed to save equipment', 'error');
    }
}

function showTypeModal(typeId = null) {
    const modal = document.getElementById('type-modal');
    const title = document.getElementById('type-modal-title');
    const form = document.getElementById('type-form');

    if (typeId) {
        title.textContent = 'Edit Equipment Type';
        const type = allEquipmentTypes.find(t => t.id === typeId);
        if (type) {
            document.getElementById('type-modal-id').value = typeId;
            document.getElementById('type-name').value = type.name || '';
            document.getElementById('type-description').value = type.description || '';
            document.getElementById('type-manager-notifications').checked = type.manager_notifications_enabled !== false;
        }
    } else {
        title.textContent = 'Add Equipment Type';
        form.reset();
        document.getElementById('type-modal-id').value = '';
        document.getElementById('type-manager-notifications').checked = true;
    }

    modal.classList.remove('hidden');
}

function hideTypeModal() {
    document.getElementById('type-modal').classList.add('hidden');
}

async function saveType() {
    const id = document.getElementById('type-modal-id').value;
    const body = {
        name: document.getElementById('type-name').value,
        description: document.getElementById('type-description').value,
        manager_notifications_enabled: document.getElementById('type-manager-notifications').checked,
    };

    const url = id ? `/api/admin/equipment-types/${id}` : '/api/admin/equipment-types';
    const method = id ? 'PUT' : 'POST';

    const result = await apiCall(url, method, body);
    if (result.success || result.type) {
        showToast(id ? 'Type updated' : 'Type created', 'success');
        hideTypeModal();
        loadEquipmentManagement();
    } else {
        showToast(result.detail || 'Failed to save type', 'error');
    }
}

async function toggleEquipmentStatus(equipmentId, newStatus) {
    const action = newStatus === 1 ? 'activate' : 'deactivate';
    if (!confirm(`Are you sure you want to ${action} this equipment?`)) {
        return;
    }

    try {
        const result = await apiCall(`/api/equipment/${equipmentId}?status=${newStatus}`, 'DELETE');

        if (result.success || result.message) {
            // Update local data
            const equipment = allEquipmentData.find(eq => eq.id === equipmentId);
            if (equipment) {
                equipment.is_active = newStatus === 1;
            }

            showToast(result.message || `Equipment ${action}d successfully`, 'success');
            loadEquipmentManagement();
        } else {
            showToast(result.detail || `Failed to ${action} equipment`, 'error');
        }
    } catch (error) {
        console.error('Error updating equipment status:', error);
        showToast(`Error ${action}ing equipment`, 'error');
    }
}

async function deleteEquipmentType(typeId) {
    if (!confirm('Are you sure you want to delete this equipment type?')) {
        return;
    }

    try {
        const result = await apiCall(`/api/admin/equipment-types/${typeId}`, 'DELETE');

        if (result.success || result.message) {
            showToast(result.message || 'Equipment type deleted', 'success');
            loadEquipmentManagement();
        } else {
            showToast(result.detail || 'Failed to delete type', 'error');
        }
    } catch (error) {
        console.error('Error deleting equipment type:', error);
        showToast('Error deleting equipment type', 'error');
    }
}

// ===============================
// Cron Jobs Section (Admin)
// ===============================
async function loadCronJobs() {
    const data = await apiCall('/api/admin/cron-jobs');
    const container = document.getElementById('cron-jobs-list');

    if (!data.jobs?.length) {
        container.innerHTML = '<div class="text-gray-500">No cron jobs configured</div>';
        return;
    }

    container.innerHTML = data.jobs.map(j => `
        <div class="card">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-semibold">${escapeHtml(j.job_name)}</div>
                        <div class="text-sm text-gray-500">${escapeHtml(j.description)}</div>
                        <div class="text-xs text-gray-400 mt-1">Schedule: ${j.cron_schedule}</div>
                        ${j.last_run_at ? `<div class="text-xs text-gray-400">Last run: ${j.last_run_at} (${j.last_run_status})</div>` : ''}
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="toggle-switch ${j.is_enabled ? 'active' : ''}"
                             onclick="toggleCronJob(${j.id}, ${!j.is_enabled})"></div>
                        <button onclick="triggerCronJob(${j.id})" class="btn-secondary text-sm">Run Now</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

async function toggleCronJob(jobId, enable) {
    const result = await apiCall(`/api/admin/cron-jobs/${jobId}`, 'PUT', { is_enabled: enable });
    if (result.success) {
        showToast(enable ? 'Job enabled' : 'Job disabled', 'success');
        loadCronJobs();
    } else {
        showToast('Failed to update job', 'error');
    }
}

async function triggerCronJob(jobId) {
    const result = await apiCall(`/api/admin/cron-jobs/${jobId}/trigger`, 'POST');
    if (result.success) {
        showToast('Job triggered successfully', 'success');
        loadCronJobs();
    } else {
        showToast(result.detail || 'Failed to trigger job', 'error');
    }
}

// ===============================
// AI Rules Section (Admin)
// ===============================
async function loadAIRules() {
    const data = await apiCall('/api/admin/ai-specification-rules');
    const container = document.getElementById('ai-rules-list');

    if (!data.rules?.length) {
        container.innerHTML = '<div class="text-gray-500">No AI rules configured</div>';
        return;
    }

    container.innerHTML = data.rules.map(r => `
        <div class="card">
            <div class="card-body">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="badge ${r.rule_type === 'general' ? 'status-active' : r.rule_type === 'parameter' ? 'status-pending' : 'status-completed'}">${r.rule_type}</span>
                            ${r.parameter_name ? `<span class="text-sm font-medium">${r.parameter_name} (${r.parameter_unit || '-'})</span>` : ''}
                            ${!r.is_enabled ? '<span class="text-xs text-red-500">Disabled</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600 mt-2 whitespace-pre-wrap">${escapeHtml(r.prompt_text?.slice(0, 200))}${r.prompt_text?.length > 200 ? '...' : ''}</div>
                    </div>
                    <button onclick="showAIRuleModal(${r.id})" class="text-orange-600 hover:underline text-sm">Edit</button>
                </div>
            </div>
        </div>
    `).join('');
}

function showAIRuleModal(ruleId = null) {
    const modal = document.getElementById('ai-rule-modal');
    const title = document.getElementById('ai-rule-modal-title');

    if (ruleId) {
        title.textContent = 'Edit AI Rule';
        // Load rule data
        apiCall(`/api/admin/ai-specification-rules`).then(data => {
            const rule = (data.rules || []).find(r => r.id === ruleId);
            if (rule) {
                document.getElementById('ai-rule-modal-id').value = ruleId;
                document.getElementById('ai-rule-type').value = rule.rule_type;
                document.getElementById('ai-rule-param-name').value = rule.parameter_name || '';
                document.getElementById('ai-rule-param-unit').value = rule.parameter_unit || '';
                document.getElementById('ai-rule-prompt').value = rule.prompt_text || '';
                document.getElementById('ai-rule-enabled').checked = rule.is_enabled;
                onRuleTypeChange();
            }
        });
    } else {
        title.textContent = 'Add AI Rule';
        document.getElementById('ai-rule-form').reset();
        document.getElementById('ai-rule-modal-id').value = '';
        document.getElementById('ai-rule-enabled').checked = true;
        onRuleTypeChange();
    }

    modal.classList.remove('hidden');
}

function hideAIRuleModal() {
    document.getElementById('ai-rule-modal').classList.add('hidden');
}

function onRuleTypeChange() {
    const type = document.getElementById('ai-rule-type').value;
    document.getElementById('parameter-fields').classList.toggle('hidden', type !== 'parameter');
}

async function saveAIRule() {
    const id = document.getElementById('ai-rule-modal-id').value;
    const body = {
        rule_type: document.getElementById('ai-rule-type').value,
        parameter_name: document.getElementById('ai-rule-param-name').value || null,
        parameter_unit: document.getElementById('ai-rule-param-unit').value || null,
        prompt_text: document.getElementById('ai-rule-prompt').value,
        is_enabled: document.getElementById('ai-rule-enabled').checked,
    };

    const url = id ? `/api/admin/ai-specification-rules/${id}` : '/api/admin/ai-specification-rules';
    const method = id ? 'PATCH' : 'POST';

    const result = await apiCall(url, method, body);
    if (result.success || result.rule) {
        showToast(id ? 'Rule updated' : 'Rule created', 'success');
        hideAIRuleModal();
        loadAIRules();
    } else {
        showToast(result.detail || 'Failed to save rule', 'error');
    }
}

// ===============================
// AI Chat Section (Admin)
// ===============================
function handleChatKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    const container = document.getElementById('chat-messages');

    // Add user message
    container.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
    input.value = '';

    // Add typing indicator
    container.innerHTML += '<div id="typing-indicator" class="typing-indicator"><span></span><span></span><span></span></div>';
    container.scrollTop = container.scrollHeight;

    try {
        const data = await apiCall('/api/ai/chat', 'POST', { message });

        // Remove typing indicator
        document.getElementById('typing-indicator')?.remove();

        // Add assistant message
        container.innerHTML += `<div class="chat-message assistant">${escapeHtml(data.response || 'No response')}</div>`;
        container.scrollTop = container.scrollHeight;
    } catch (e) {
        document.getElementById('typing-indicator')?.remove();
        container.innerHTML += '<div class="chat-message assistant">Sorry, I encountered an error. Please try again.</div>';
    }
}

function clearChat() {
    document.getElementById('chat-messages').innerHTML = `
        <div class="chat-message assistant">
            Hello! I'm your AI assistant. I can help you with equipment recommendations, answer questions about specifications, or assist with booking decisions. How can I help you today?
        </div>
    `;
}

// ===============================
// Auth
// ===============================
async function logout() {
    await apiCall('/api/auth/logout', 'POST');
    window.location.href = '/login';
}

// ===============================
// Sidebar Date Display
// ===============================
function updateSidebarDate() {
    const dateEl = document.getElementById('sidebar-date');
    if (!dateEl) return;

    const now = new Date();
    const weekNumber = getWeekNumber(now);

    // Short day names
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const dayName = dayNames[now.getDay()];
    const monthName = monthNames[now.getMonth()];
    const day = now.getDate();
    const year = now.getFullYear();

    dateEl.textContent = `${dayName}, ${monthName} ${day}, ${year}, KW${weekNumber}`;
}

// ===============================
// Initialize
// ===============================
document.addEventListener('DOMContentLoaded', () => {
    updateSidebarDate();
    // Read section from URL hash or default to 'information'
    const hash = window.location.hash.slice(1);
    const initialSection = hash || 'information';
    showSection(initialSection, false); // Don't update hash if it's already set
});
</script>
{% endblock %}
